<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Summer Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Summer Blog">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Summer Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Summer Blog">
<meta name="twitter:description">
  
    <link rel="alternate" href="/atom.xml" title="Summer Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Summer Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-iOS-æ’­æ”¾æœ¬åœ°éŸ³é¢‘" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/24/iOS-æ’­æ”¾æœ¬åœ°éŸ³é¢‘/" class="article-date">
  <time datetime="2016-10-24T10:05:02.000Z" itemprop="datePublished">2016-10-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/24/iOS-æ’­æ”¾æœ¬åœ°éŸ³é¢‘/">iOS æ’­æ”¾æœ¬åœ°éŸ³é¢‘</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<font color="#0099ff" size="3" face="é»‘ä½“">äº§å“åŒå­¦æƒ³è¦å®ç°ä¸€ä¸ªåŠŸèƒ½:ç”¨æˆ·å®ŒæˆæŸä¸ªä»»åŠ¡æ—¶,è¿›è¡Œè¯­éŸ³æç¤º. äºæ˜¯è¿™ä¸ªç®€å•çš„è¦æ±‚,æŠ˜ç£¨æˆ‘3å¤©(ï¼›â€²âŒ’`), å®è·µè¯æ˜,å¼€å‘ä¹‹å‰çš„å……åˆ†è°ƒç ”èƒ½å¤Ÿå°‘èµ°å¼¯è·¯; å¼€å‘ç»éªŒä¹Ÿçš„ç¡®èƒ½å¤Ÿç¼©çŸ­å¼€å‘æ—¶é—´</font>

</blockquote>
<h2 id="é‚£äº›è‡ªå·±å°è¯•-zou-è¿‡-guo-çš„-de-æ–¹-wan-æ³•-lu-ğŸ’¨"><a href="#é‚£äº›è‡ªå·±å°è¯•-zou-è¿‡-guo-çš„-de-æ–¹-wan-æ³•-lu-ğŸ’¨" class="headerlink" title="é‚£äº›è‡ªå·±å°è¯•(zou)è¿‡(guo)çš„(de)æ–¹(wan)æ³•(lu)ğŸ’¨"></a>é‚£äº›è‡ªå·±å°è¯•(zou)è¿‡(guo)çš„(de)æ–¹(wan)æ³•(lu)ğŸ’¨</h2><ul>
<li>å®šæ—¶å£°éŸ³æ¨é€(UILocalNotification), ç±»ä¼¼é—¹é’Ÿçš„åŠŸèƒ½,åˆ°äº†æŒ‡å®šæ—¶é—´å,å“èµ·ä¸€æ®µéŸ³ä¹. ç„¶è€Œè¿™æ ·åšçš„é—®é¢˜åœ¨äº,å¹¶ä¸çŸ¥é“ç”¨æˆ·ä»€ä¹ˆæ—¶å€™åšä»»åŠ¡; ä¸”ä»»åŠ¡åˆ‡å‡ºç•Œé¢å,ä»»åŠ¡éœ€è¦ç»“æŸ. æœ¬åœ°é€šçŸ¥ä¸èƒ½æ»¡è¶³è¦æ±‚Ë‡ËË‡ ,æ”¾å¼ƒ</li>
<li>AVAudioPlayeræ’­æ”¾æœ¬åœ°éŸ³é¢‘, è¿™ä¸ªå¥½,æ£’æäº†,å¼€å‘å®Œä¹‹å,å‘ç°äº§å“éœ€è¦éŸ³ä¹èƒ½å¤Ÿåå°é…ç½®(è®ºè¯»æ‡‚éœ€æ±‚çš„é‡è¦æ€§),ä¸”éŸ³ä¹æ—¶é•¿ä¹Ÿè®¸ä¼šè¶…è¿‡30s. å†å¼ƒ</li>
<li>æœ€åé€‰æ‹©äº†AVPlayer</li>
</ul>
<h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p>1.AVAudioPlayerå’ŒAVPlayerå£°æ˜å¯¹è±¡éƒ½éœ€è¦è®¾ç½®æˆå…¨å±€å˜é‡<br>2.AVAudioPlayerå’ŒAVPlayeréƒ½éœ€è¦å¼•å…¥AVFoundationæ¡†æ¶<br>3.iOS9å¼•å…¥äº†æ–°ç‰¹æ€§App Transport Security (ATS),éœ€è¦åœ¨plistä¸­æ·»åŠ æƒé™. æ·»åŠ æ–¹å¼:å·¦é”®Info.plisté€‰æ‹©open with source code</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;key&gt;NSAppTransportSecurity&lt;/key&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">	&lt;key&gt;NSAllowsArbitraryLoads&lt;/key&gt;</span><br><span class="line">	&lt;true/&gt;</span><br><span class="line">&lt;/dict&gt;</span><br></pre></td></tr></table></figure>
<h2 id="å†™ä»£ç "><a href="#å†™ä»£ç " class="headerlink" title="å†™ä»£ç "></a>å†™ä»£ç </h2><p>1.åŠ è½½éŸ³é¢‘æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//æ’­æ”¾æœ¬åœ°éŸ³é¢‘</span><br><span class="line">  NSString *filePath = [[NSBundle mainBundle] pathForResource:@&quot;ç‹¬è§’æˆ&quot;  ofType:@&quot;mp3&quot;];</span><br><span class="line">  NSURL *sourceMovieUrl =  [NSURL fileURLWithPath:filePath];</span><br><span class="line">  //æ’­æ”¾ç½‘ç»œéŸ³é¢‘</span><br><span class="line">  //NSURL *sourceMovieUrl = [NSURL URLWithString:urlString]</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç ä¸­æœ¬åœ°éŸ³é¢‘å’Œåœ¨çº¿éŸ³é¢‘çš„ä¸»è¦åŒºåˆ«åœ¨äºè·¯å¾„çš„ä¸åŒ:æœ¬åœ°è·¯å¾„ä½¿ç”¨<code>[NSURL fileURLWithPath:æœ¬åœ°éŸ³é¢‘è·¯å¾„]</code>,åœ¨çº¿éŸ³é¢‘ä½¿ç”¨<code>[NSURL URLWithString:åœ¨çº¿éŸ³ä¹åœ°å€]</code></p>
<p>2.åˆ›å»ºAVPlayer</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AVAsset *movieAsset = [AVURLAsset URLAssetWithURL:sourceMovieUrl options:nil];</span><br><span class="line">self.timerPlayerItem = [AVPlayerItem playerItemWithAsset:movieAsset];</span><br><span class="line"></span><br><span class="line">//è¿™æ˜¯ç”¨æ¥æ”¯æŒåå°æ’­æ”¾çš„</span><br><span class="line">AVAudioSession *audioSession = [AVAudioSession sharedInstance];</span><br><span class="line">NSError *setCategoryError = nil;</span><br><span class="line">[audioSession setCategory:AVAudioSessionCategoryPlayback error:&amp;setCategoryError];</span><br><span class="line"></span><br><span class="line">[audioSession setActive:YES error:nil];</span><br><span class="line">if (setCategoryError) &#123;</span><br><span class="line">    NSLog(@&quot;è¿™é‡Œæœ‰é—®é¢˜ %@&quot;,setCategoryError);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">self.timerPlayer = [[AVPlayer alloc]initWithPlayerItem:self.timerPlayerItem];</span><br></pre></td></tr></table></figure>
<p>æœ‰äº†éŸ³é¢‘æ–‡ä»¶çš„è·¯å¾„,å‰©ä¸‹çš„å°±æ˜¯å°†éŸ³ä¹æ’­æ”¾å‡ºæ¥äº†.ä¸Šé¢çš„ä»£ç æœ‰ä¿©ä¸ªä½œç”¨:1.åˆ›å»ºAVAudioSessionä½¿å¾—æ’­æ”¾å™¨æ”¯æŒåå°æ’­æ”¾ 2.åˆ›å»ºéŸ³é¢‘æ’­æ”¾å™¨. å…¶ä¸­ä»£ç ä¸­ç”¨åˆ°çš„<code>AVAsset</code>æ˜¯ä¸ªæŠ½è±¡ç±»,ä¸èƒ½å¤Ÿå•ç‹¬ä½¿ç”¨.</p>
<p>3.æ’­æ”¾</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[self.timerPlayer play];</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä»…ä»…æ˜¯æ’­æ”¾éŸ³ä¹,ä¸Šé¢çš„ä»£ç å°±è¶³å¤Ÿäº†,ä½†å¾€å¾€æ’­æ”¾éŸ³ä¹åè¿˜éœ€è¦è®¸å¤šæ“ä½œ,æ¯”å¦‚éŸ³ä¹å®Œæˆåç•Œé¢éœ€è¦æç¤ºå•Š,éŸ³ä¹æ’­æ”¾è¿›åº¦ç­‰ç­‰. äºæ˜¯å°±æœ‰äº†ä¸‹é¢çš„ç›‘å¬</p>
<p>4.æ·»åŠ å’Œç§»é™¤ç›‘å¬</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//æ·»åŠ ç›‘å¬</span><br><span class="line">- (void)addObserverForPlayerItem</span><br><span class="line">&#123;</span><br><span class="line">    [self.timerPlayer.currentItem addObserver:self forKeyPath:@&quot;status&quot; options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:nil];</span><br><span class="line">    [self.timerPlayer.currentItem addObserver:self forKeyPath:@&quot;loadedTimeRanges&quot; options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:nil];</span><br><span class="line">    </span><br><span class="line">    //æ·»åŠ éŸ³ä¹æ’­æ”¾å®Œæˆçš„é€šçŸ¥</span><br><span class="line">    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(itemDidFinishPlaying) name:AVPlayerItemDidPlayToEndTimeNotification object:self.timerPlayer.currentItem];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//ç§»é™¤ç›‘å¬</span><br><span class="line">- (void)removeObserverForPlayerItem</span><br><span class="line">&#123;</span><br><span class="line">    [self.timerPlayer.currentItem removeObserver:self forKeyPath:@&quot;status&quot;];</span><br><span class="line">    [self.timerPlayer.currentItem removeObserver:self forKeyPath:@&quot;loadedTimeRanges&quot;];</span><br><span class="line">    [[NSNotificationCenter defaultCenter] removeObserver:self name:AVPlayerItemDidPlayToEndTimeNotification object:self.timerPlayer.currentItem];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç åˆ©ç”¨KVOå±æ€§ç›‘å¬äº†<code>status</code>å’Œ<code>loadedTimeRanges</code>å±æ€§,å¹¶æ·»åŠ äº†<code>AVPlayerItemDidPlayToEndTimeNotification</code>é€šçŸ¥;<code>status</code>æ˜¯å¯¹playerçš„çŠ¶æ€çš„æšä¸¾å€¼,å½“<code>status = readytoplay</code>æ—¶å€™æ‰èƒ½æ’­æ”¾èµ„æºæˆ–è¿›è¡Œå…¶ä»–çš„ç•Œé¢å¤„ç†,<code>loadedTimeRanges</code>çš„å±æ€§ç›‘å¬å¯ä»¥è·å¾—å½“å‰èµ„æºçš„ç¼“å†²è¿›åº¦.ä¸‹é¢æ˜¯å¯¹å±æ€§ç›‘å¬åçš„æ“ä½œç¤ºä¾‹å’Œæ”¶åˆ°<code>AVPlayerItemDidPlayToEndTimeNotification</code>é€šçŸ¥åæ‰§è¡Œçš„æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context</span><br><span class="line">&#123;</span><br><span class="line">    if ([keyPath isEqualToString:@&quot;status&quot;]) &#123;</span><br><span class="line">        int status = ((NSNumber *)change[@&quot;new&quot;]).intValue;</span><br><span class="line">        if (status == AVPlayerStatusReadyToPlay) &#123;</span><br><span class="line">            //è¿›è¡Œç›¸åº”çš„ç•Œé¢å¤„ç†</span><br><span class="line">            NSLog(@&quot;hehehheeh&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;else if ([keyPath isEqualToString:@&quot;loadedTimeRanges&quot;])&#123;</span><br><span class="line">        NSArray *array = self.timerPlayer.currentItem.loadedTimeRanges;</span><br><span class="line">        CMTimeRange timeRanges = [array.firstObject CMTimeRangeValue];</span><br><span class="line">        float startSeconds =  CMTimeGetSeconds(timeRanges.start);</span><br><span class="line">        float durationSeconds = CMTimeGetSeconds(timeRanges.duration);</span><br><span class="line">        //è·å–ç¼“å†²æ—¶é—´</span><br><span class="line">        float bufferTime = startSeconds + durationSeconds;</span><br><span class="line">        NSLog(@&quot;%f&quot;,bufferTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)itemDidFinishPlaying</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;ç»ˆäºå®Œäº‹äº†&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®Œæˆäº†ä¸Šé¢è¿™äº›ä»£ç ,åŸºæœ¬èƒ½å¤Ÿæ»¡è¶³äº§å“å¯¹äºæ’­æ”¾éŸ³ä¹çš„éœ€æ±‚äº†.ä½†æ˜¯è€ƒè™‘åˆ°é…ç½®çš„æç¤ºéŸ³å¹¶ä¸é•¿,æ‰€ä»¥é¢†å¯¼å¸Œæœ›éŸ³é¢‘ç¼“å­˜åˆ°æœ¬åœ°åå†è¿›è¡Œæ’­æ”¾,æ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦ä¸‹è½½éŸ³ä¹æ–‡ä»¶</p>
<h2 id="ä¸‹è½½æ–‡ä»¶"><a href="#ä¸‹è½½æ–‡ä»¶" class="headerlink" title="ä¸‹è½½æ–‡ä»¶"></a>ä¸‹è½½æ–‡ä»¶</h2><p>1.è®¾ç½®æœ¬åœ°æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> ä¸‹è½½åçš„éŸ³é¢‘å­˜æ”¾è·¯å¾„</span><br><span class="line"></span><br><span class="line"> @param fileName         æ–‡ä»¶åç§°</span><br><span class="line"> @param isFileExistBlock å›è°ƒ</span><br><span class="line"> */</span><br><span class="line">- (void)audioFilePath:(NSString *)fileName</span><br><span class="line">          isFileExist:(void(^)(BOOL isExist, NSString*savePath))isFileExistBlock</span><br><span class="line">&#123;</span><br><span class="line">    NSString *cachePath=[NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];</span><br><span class="line">    </span><br><span class="line">    NSString *savePath=[cachePath stringByAppendingPathComponent:[NSString stringWithFormat:@&quot;audio_%@&quot;,fileName]];</span><br><span class="line">    NSLog(@&quot;%@&quot;,savePath);</span><br><span class="line">    </span><br><span class="line">    //é¦–å…ˆåˆ¤æ–­å½“å‰è·¯å¾„æ˜¯å¦å­˜åœ¨</span><br><span class="line">    NSFileManager *fileManager = [NSFileManager defaultManager];</span><br><span class="line">    BOOL isPathExist = [fileManager fileExistsAtPath:savePath];</span><br><span class="line">    if (isPathExist)</span><br><span class="line">    &#123;</span><br><span class="line">        //å­˜åœ¨ç›¸åŒçš„æ–‡ä»¶</span><br><span class="line">        if (isFileExistBlock) &#123; isFileExistBlock(YES, savePath); &#125;</span><br><span class="line"></span><br><span class="line">    &#125;else</span><br><span class="line">    &#123;</span><br><span class="line">        if (isFileExistBlock) &#123; isFileExistBlock(NO, savePath); &#125;</span><br><span class="line">        //åˆ¤æ–­å½“å‰è·¯å¾„ä¸‹æ–‡ä»¶ä¸ªæ•°,ä¸ªæ•°å¤§äº5æ—¶,åˆ é™¤æ–‡ä»¶</span><br><span class="line">        NSArray *array = [fileManager contentsOfDirectoryAtPath:savePath error:nil];</span><br><span class="line">        if (array.count &gt; 4)</span><br><span class="line">        &#123;</span><br><span class="line">            [fileManager removeItemAtPath:savePath error:nil];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™éƒ¨åˆ†ä»£ç åšäº†ä¸€ä¸ªå¯¹ç¼“å­˜æ–‡ä»¶çš„ç®€å•åˆ¤æ–­:å½“ç¼“å­˜æ–‡ä»¶å·²ç»å­˜åœ¨çš„æ—¶å€™,è¿”å›æ ‡è¯†ç¬¦YES;ç¼“å­˜æ–‡ä»¶æ•°é‡å¤§äº4æ—¶åˆ é™¤æ²™ç›’ä¸­çš„æ–‡ä»¶</p>
<p>2.ä¸‹è½½èµ„æº</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> æ ¹æ®é“¾æ¥åœ°å€ä¸‹è½½éŸ³é¢‘</span><br><span class="line"></span><br><span class="line"> @param urlString ä¸‹è½½</span><br><span class="line"> @param block     block</span><br><span class="line"> */</span><br><span class="line">- (void)downLoadAudioWithUrlString:(NSString *)urlString</span><br><span class="line">                     downloadBlock:(DownloadAudioFinishBlock)block</span><br><span class="line">&#123;</span><br><span class="line">   // NSURL *soundURL = [NSURL URLWithString:@&quot;http://yinyueshiting.baidu.com/data2/music/122873158/4904681476817261128.mp3?xcode=1276ea4c54f0c8f829676627b54cb918&quot;];</span><br><span class="line">    NSURL *soundURL = [NSURL URLWithString:urlString];</span><br><span class="line"></span><br><span class="line">    NSLog(@&quot;soundURL:%@&quot;,soundURL);</span><br><span class="line">    </span><br><span class="line">    //å°†è·¯å¾„æ‹†åˆ†æˆarray,ç„¶åä¿å­˜æ–‡ä»¶åç§°</span><br><span class="line">    NSArray *seperateArray = [urlString componentsSeparatedByString:@&quot;/&quot;];</span><br><span class="line">    NSString *fileName = seperateArray.lastObject;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    [self audioFilePath:fileName isFileExist:^(BOOL isExist, NSString *savePath)</span><br><span class="line">     &#123;</span><br><span class="line">         //å­˜åœ¨æ–‡ä»¶</span><br><span class="line">         if (isExist)&#123;</span><br><span class="line">             if (block) &#123; block(savePath, nil);&#125;</span><br><span class="line">         &#125;</span><br><span class="line">         //ä¸å­˜åœ¨æ–‡ä»¶</span><br><span class="line">         else</span><br><span class="line">         &#123;</span><br><span class="line">             //åˆ›å»ºç½‘ç»œè¯·æ±‚</span><br><span class="line">             NSMutableURLRequest *theRequest = [NSMutableURLRequest requestWithURL:soundURL];</span><br><span class="line">             NSURLSession *session  = [NSURLSession sharedSession];</span><br><span class="line">             </span><br><span class="line">             //æ ¹æ®é“¾æ¥åœ°å€ä¸‹è½½éŸ³é¢‘åˆ°æŒ‡å®šåœ°å€</span><br><span class="line">             NSURLSessionDownloadTask *downloadTask = [session downloadTaskWithRequest:theRequest completionHandler:^(NSURL * _Nullable location, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</span><br><span class="line">                 if (!error) &#123;</span><br><span class="line">                     </span><br><span class="line">                     //æ³¨æ„locationæ˜¯ä¸‹è½½åçš„ä¸´æ—¶ä¿å­˜è·¯å¾„,éœ€è¦å°†å®ƒç§»åŠ¨åˆ°éœ€è¦ä¿å­˜çš„ä½ç½®</span><br><span class="line">                     </span><br><span class="line">                      NSError *saveError;</span><br><span class="line">                      //å­˜å‚¨æ–‡ä»¶</span><br><span class="line">                      NSURL *saveUrl=[NSURL fileURLWithPath:savePath];</span><br><span class="line">                      [[NSFileManager defaultManager] copyItemAtURL:location toURL:saveUrl error:</span><br><span class="line">                       &amp;saveError];</span><br><span class="line">                      if (!saveError) &#123;</span><br><span class="line">                          NSLog(@&quot;save sucess.&quot;);</span><br><span class="line">                          if (block) &#123; block(savePath, nil);&#125;</span><br><span class="line">                      &#125;else&#123;</span><br><span class="line">                          NSLog(@&quot;error is :%@&quot;,saveError.localizedDescription);</span><br><span class="line">                          if (block) &#123; block(nil, saveError);&#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                 </span><br><span class="line">                 &#125;else&#123;</span><br><span class="line">                     NSLog(@&quot;error is :%@&quot;,error.localizedDescription);</span><br><span class="line">                     </span><br><span class="line">                     if ([error.localizedDescription containsString:@&quot; already exists&quot;]) &#123;</span><br><span class="line">                         if (block) &#123; block(savePath, nil);&#125;</span><br><span class="line">                     &#125;else&#123;</span><br><span class="line">                         if (block) &#123; block(nil, error);&#125;</span><br><span class="line"></span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 </span><br><span class="line">             &#125;];</span><br><span class="line">             [downloadTask resume];</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç ä¸­çš„urlæ˜¯ä»ç™¾åº¦ä¸­æ‰¾åˆ°çš„éŸ³ä¹ä¸‹è½½åœ°å€,è¿™é‡Œä¸‹è½½éŸ³ä¹å’Œæ–‡ä»¶æ˜¯ä¸€æ ·çš„,å¦‚æœç½‘é€Ÿå¤ªæ…¢,å»ºè®®æ‰¾ä¸ªçŸ­ç‚¹çš„éŸ³ä¹æˆ–è€…æ–‡ä»¶ä¹‹ç±».æ­¤å¤„å­˜æ”¾éŸ³ä¹çš„åç§°ä¸ºurlæˆªå–çš„ä¸€éƒ¨åˆ†. è¿™æ ·ä¸‹è½½æ–‡ä»¶å°±å®Œæˆå•¦.</p>
<p><a href="https://github.com/XQ0820/PlayAudio" target="_blank" rel="external">ä¸Šé¢æ–‡ç« çš„ä»£ç æ”¾åœ¨è¿™é‡Œäº†:</a></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¹‹å‰å¬æç¬‘æ¥è€å¸ˆçš„è®²åº§,ä»–æåˆ°â€è¾“å‡ºèƒ½å¤Ÿæœ‰æ•ˆåœ°æ¨åŠ¨è¾“å…¥â€. è‡ªå·±å†™è¿™ç¯‡æ–‡ç« ç•¥ç•¥èƒ½æ„Ÿå—åˆ°è¿™ä¸€ç‚¹,å¹³æ—¶è¯»åˆ«äººçš„æŠ€æœ¯åšå®¢æ€»æ˜¯3~5åˆ†é’Ÿå°±çœ‹è¿‡å»äº†,ç°åœ¨æƒ³æƒ³åº”è¯¥å¥½å¥½æ„Ÿè°¢æ‰€æœ‰ç»™è‡ªå·±æä¾›è¿‡å¸®åŠ©çš„åšå®¢.æœ‰äº†è°·æ­Œ,å°±å¥½åƒæ‹¥æœ‰æ•´ä¸ªå®‡å®™,ä¹Ÿå¸Œæœ›èƒ½é€šè¿‡åšå®¢çš„å½¢å¼ç»™è‡ªå·±å¢åŠ ä¸€äº›æ–°é²œçš„æ„Ÿå—,å’Œå¤šä¸€äº›è¿›æ­¥.</p>
<h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p>Haleâ€™s Blog: <a href="http://wuqiuhao.github.io/2016/04/05/iOS%E8%A7%86%E9%A2%91%E3%80%81%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE/" target="_blank" rel="external">http://wuqiuhao.github.io/2016/04/05/iOS%E8%A7%86%E9%A2%91%E3%80%81%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE/</a><br>iOS éŸ³é¢‘æ’­æ”¾ â€”â€” ç¦»çº¿æ­Œæ›²:<a href="http://www.jianshu.com/p/2fdc6a9142c4" target="_blank" rel="external">http://www.jianshu.com/p/2fdc6a9142c4</a><br>ç å†œäººç”ŸéŸ³é¢‘æ’­æ”¾ç³»åˆ—(å¤§ç¥çš„æ–‡ç« ç‰›ç‰›å“’!):<a href="http://msching.github.io/blog/2014/07/08/audio-in-ios-2/" target="_blank" rel="external">http://msching.github.io/blog/2014/07/08/audio-in-ios-2/</a><br>AVAudioPlayer,AVPlayerä»¥åŠç³»ç»ŸéŸ³é¢‘:<a href="http://www.jianshu.com/p/e5dbd92871a4" target="_blank" rel="external">http://www.jianshu.com/p/e5dbd92871a4</a><br>iOSéŸ³é¢‘ç¯‡ï¼šä½¿ç”¨AVPlayeræ’­æ”¾ç½‘ç»œéŸ³ä¹:<a href="http://www.jianshu.com/p/32b932f44c9b" target="_blank" rel="external">http://www.jianshu.com/p/32b932f44c9b</a><br>iOS Programming 101: Record and Play Audio using AVFoundation Framework:<a href="https://www.appcoda.com/ios-avfoundation-framework-tutorial/" target="_blank" rel="external">https://www.appcoda.com/ios-avfoundation-framework-tutorial/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/10/24/iOS-æ’­æ”¾æœ¬åœ°éŸ³é¢‘/" data-id="ciytk1esa0004psuxnmvgaewt" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="w-iOS10ç”¨æˆ·é€šçŸ¥æ¡†æ¶-User-Notifications-ç®€ä»‹-ç¿»è¯‘" class="article article-type-w" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/17/iOS10ç”¨æˆ·é€šçŸ¥æ¡†æ¶-User-Notifications-ç®€ä»‹-ç¿»è¯‘/" class="article-date">
  <time datetime="2016-10-17T02:27:24.000Z" itemprop="datePublished">2016-10-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/17/iOS10ç”¨æˆ·é€šçŸ¥æ¡†æ¶-User-Notifications-ç®€ä»‹-ç¿»è¯‘/">iOS10ç”¨æˆ·é€šçŸ¥æ¡†æ¶(User Notifications)ç®€ä»‹(ç¿»è¯‘)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="http://www.appcoda.com/ios10-user-notifications-guide/" target="_blank" rel="external">http://www.appcoda.com/ios10-user-notifications-guide/</a></p>
<p>å¤§å®¶å¥½,æ¬¢è¿æ¥åˆ°iOS10æ•™ç¨‹çš„é€šçŸ¥æŒ‡å—. ä»Šå¤©,æˆ‘ä»¬å°†èŠä¸€ä¸‹åœ¨iOS10ç³»ç»Ÿä¸­å¦‚ä½•å®ç°é€šçŸ¥. iOS10çš„é€šçŸ¥APIæ–°å¢å’Œä¿®æ”¹äº†è®¸å¤šç‰¹æ€§,åŒ…æ‹¬åŸºäºè§¦å‘å™¨(triggers)çš„ç‰›æ°çš„è¯·æ±‚ç³»ç»Ÿ,è¯¦ç»†å†…å¦‚ä¼šåœ¨ä¸‹æ–‡ä¸­è¯¦ç»†è®¨è®º.<br>iOS10é€šçŸ¥ä¸­æœ€å¤§çš„æ”¹å˜æ˜¯<code>UserNotificationsUI</code>çš„æ¡†æ¶,å®ƒå¯ä»¥åœ¨é€šçŸ¥ä¸­è‡ªå®šä¹‰è§†å›¾æ§åˆ¶å™¨.è¿™å°±å…è®¸åˆ›å»ºè®¸å¤šä¹‹å‰ç³»ç»Ÿä¸­å®Œå…¨ä¸å¯èƒ½çš„å¾ˆæœ‰ç”¨çš„å„ç§é€šçŸ¥</p>
<h2 id="ç®€å•çš„ç”¨æˆ·é€šçŸ¥"><a href="#ç®€å•çš„ç”¨æˆ·é€šçŸ¥" class="headerlink" title="ç®€å•çš„ç”¨æˆ·é€šçŸ¥"></a>ç®€å•çš„ç”¨æˆ·é€šçŸ¥</h2><p>æˆ‘ä»¬æƒ³è¦å±•ç¤ºçš„é€šçŸ¥å¹¶ä¸å…¨æ˜¯ç²¾è‡´ä¸”å¯äº¤äº’çš„.å› æ­¤,æ¥ä¸‹æ¥å¼€å§‹æ¼”ç¤ºæ€ä¹ˆå»ºç«‹ä¸€ä¸ªåŸºæœ¬çš„æ–‡æœ¬é€šçŸ¥.ä¸‹è½½<a href="https://github.com/appcoda/NotificationsUI-Demo/raw/master/NotificationsUI.zip" target="_blank" rel="external">åˆå§‹å·¥ç¨‹</a>å¹¶æ‰“å¼€ <code>NotificationsUI.xcodeproj</code>. çœ‹ä¸€ä¸‹æ•´ä¸ªå·¥ç¨‹,ä½ ä¼šå‘ç°ä»€ä¹ˆéƒ½æ²¡æœ‰:æˆ‘ä»¬ç”¨ <code>Main.storyboard</code> ç»“åˆ <code>ViewController.swift</code> å’Œ <code>AppDelegate.swift</code> è¿›è¡Œç”¨æˆ·äº¤äº’<br><img src="/img/14764273540293.png" alt=""></p>
<p>æ‰“å¼€ <code>Main.storyboard</code> çœ‹ä¸€ä¸‹ <code>ViewController</code> æ–‡ä»¶. ä»Šå¤©æˆ‘ä»¬åšçš„è¿™ä¸ªappleç”¨æ¥æé†’ç”¨æˆ·ä¸Šç½‘æœˆåº¦AppCodaçš„æ–‡ç« .å®ƒè®©ç”¨æˆ·é€‰æ‹©éœ€è¦é€šçŸ¥çš„æ—¥æœŸå’Œæ—¶é—´.é¦–å…ˆå¯¹è¿™ä¸ªappåšä¸€ç®€å•çš„ä¿®æ”¹:å¯ç”¨é€šçŸ¥. ç›®å‰é€‰æ‹©æ—¶é—´å’Œæ—¥æœŸä¸€ç‚¹ç”¨éƒ½æ²¡æœ‰.æˆ‘ä»¬å°†è¦æ›´æ–°è¿™ä¸ªapp,ä½¿å¾—å®ƒåœ¨è®¾ç½®æ—¶é—´å’Œæ—¥æœŸååœ¨æŒ‡å®šæ—¶é—´åˆ›å»ºé€šçŸ¥.</p>
<p>ç»§ç»­æ‰“å¼€ <code>ViewController.swift</code> è®©æˆ‘ä»¬å¼€å§‹å§.</p>
<p>å½“ä½ æ‰“å¼€ <code>ViewController.swift</code> æ—¶, ä½ ä¼šå‘ç°æ–‡ä»¶å¾ˆç©º. åªæœ‰ä¸€ä¸ªåœ¨æ—¶é—´é€‰æ‹©å™¨é€‰æ‹©äº†æ–°çš„æ—¶é—´å,ä¼šè¢«è°ƒç”¨çš„åŠŸèƒ½å‡½æ•°<code>datePickerDidSelectNewDate</code>.åƒå‰é¢æåˆ°çš„,ç°åœ¨è¿™ä¸ªappé™¤äº†åˆ›å»ºé€šä¹‹å¤–ä»€ä¹ˆéƒ½æ²¡åš. è®©æˆ‘ä»¬æ¥å®ç°è¿™ä¸ªåŠŸèƒ½</p>
<p>åœ¨iOS10ä¸­åˆ›å»ºé€šçŸ¥çš„è¿‡ç¨‹æœ‰ä¸€ç‚¹å˜åŒ–.å¼€å‘äººå‘˜ç°åœ¨å¿…é¡»åˆ›å»º<em>requests</em>,å‘iOSè¯·æ±‚å±•ç¤ºé€šçŸ¥.è¿™äº›è¯·æ±‚åŒ…æ‹¬ä¿©éƒ¨åˆ†: <em>triggers</em> å’Œ <em>content</em> (è§¦å‘å™¨å’Œå†…å®¹).ä¸€ä¸ªè§¦å‘å™¨æ˜¯ä¸€ç³»åˆ—å‘é€é€šçŸ¥æ‰€å¿…é¡»æ»¡è¶³çš„æ¡ä»¶.ä¸ºäº†åœ¨iOS10ä¸­æ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥,é¦–å…ˆä»è§¦å‘å™¨å¼€å§‹.æˆ‘ä»¬ä½¿ç”¨çš„åŸºäºæ—¶é—´çš„è§¦å‘å™¨çš„ç±»æ˜¯<code>UNCalendarNotificationTrigger</code>. Appleæä¾›äº†ä¹Ÿæä¾›äº†å…¶ä»–çš„ç±»,ä¾‹å¦‚ <code>UNLocationNotificationTrigger</code> (å½“ç”¨æˆ·åˆ°è¾¾æŒ‡å®šåœ°ç‚¹æ—¶è§¦å‘é€šçŸ¥)</p>
<p>åƒä¸Šé¢å£°æ˜çš„: åœ¨iOSä¸­å±•ç¤ºé€šçŸ¥çš„ç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨.ç°åœ¨,è®©æˆ‘ä»¬ç»§ç»­å¹¶ä¸”åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨.</p>
<p>æ‰“å¼€ <code>AppDelegate.swift</code>, ç¡®ä¿å·²ç»å¯¼å…¥äº† <code>UserNotification</code>æ¡†æ¶, æ‰€æœ‰é€šçŸ¥ç›¸å…³çš„APIéƒ½åœ¨è¿™ä¸ªæ¡†æ¶é‡Œé¢:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import UserNotifications</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥,æ·»åŠ å‡½æ•°<code>scheduleNotification(at date: Date)</code>.åå¦‚å…¶ä¹‰,è¿™ä¸ªå‡½æ•°è´Ÿè´£åœ¨æä¾›çš„æ—¥æœŸå†…å®šåˆ¶ä¸€ä¸ªé€šçŸ¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func scheduleNotification(at date: Date) &#123;</span><br><span class="line">    let calendar = Calendar(identifier: .gregorian)</span><br><span class="line">    let components = calendar.dateComponents(in: .current, from: date)</span><br><span class="line">    let newComponents = DateComponents(calendar: calendar, timeZone: .current, month: components.month, day: components.day, hour: components.hour, minute: components.minute)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­, ä½¿ç”¨ <code>Gregorian</code> æ—¥å†å°†æä¾›çš„æ—¥æœŸåˆ†æˆå‡ ä¸ªç»„ä»¶.æ—¥æœŸä¸ç»„ä»¶ä¸åœ¨è¿™ä¸ªæ•™ç¨‹çš„èŒƒå›´å†…,ä½†éœ€è¦çŸ¥é“ä¸€ä¸ªæ—¥æœŸç”±ç»„ä»¶ç»„æˆ.å•ç‹¬å±•ç¤ºæ—¥æœŸçš„ç»„ä»¶,ä¾‹å¦‚å°æ—¶,åˆ†é’Ÿ,ç§’ç­‰.åˆšæ‰çš„ä»£ç å°†æ—¶é—´æ‹†åˆ†æˆç»„ä»¶å¹¶ä¿å­˜åœ¨ <code>components</code> å¸¸é‡ä¸­.è¿™æ ·åšæ˜¯å› ä¸ºæ‰§è¡Œ <code>UNCalendarNotificationTrigger</code> éœ€è¦æ—¥æœŸç»„ä»¶è€Œä¸æ˜¯æ—¥æœŸ. ç„¶è€Œ, <code>UNCalendarNotificationTrigger</code>æ¯”è¾ƒè¯¡å¼‚çš„ä¸€ç‚¹æ˜¯ç›´æ¥ä»æ—¥æœŸä¸­å–å‡ºå®Œæ•´çš„ç»„ä»¶å¹¶ä¸èƒ½ä½¿ç”¨, è€Œéœ€è¦ä»å·²å­˜åœ¨çš„å®ä¾‹ä¸­è¯»å–ä¿¡æ¯åˆ›å»ºè‡ªå·±çš„ <code>DateComponents</code> å®ä¾‹. ç¬¬ä¸‰è¡Œä»£ç å°±æ˜¯åšè¿™ä¸ªçš„:å®ƒåªæ˜¯ä» <code>date</code> ä¸­è·å–äº†ç›¸å…³ä¿¡æ¯åˆ›å»ºäº†æ–°çš„ <code>DateComponents</code> å®ä¾‹.</p>
<p>ç°åœ¨æœ‰äº† <code>date</code> çš„ç»„ä»¶, ç»§ç»­å•Šåˆ›å»ºæ—¥å†é€šçŸ¥è§¦å‘å™¨. åƒåœ¨iOSä¸­çš„å…¶ä»–ä¸œè¥¿ä¸€æ ·, <em>Apple</em>ä½¿è¿™ä¸ªåˆ›å»ºè¿‡ç¨‹ç›¸å½“ç®€å•. åªéœ€è¦å°†ä¸‹é¢çš„ä»£ç åŠ å…¥å‡½æ•°ä¸­:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let trigger = UNCalendarNotificationTrigger(dateMatching: newComponents, repeats: false)</span><br></pre></td></tr></table></figure></p>
<p>è·Ÿé¢„æƒ³çš„ä¸€æ ·,è¿™è¡Œä»£ç ç”¨æ—¶é—´ç»„ä»¶åˆ›å»ºäº†æ–°çš„ <code>UNCalendarNotificationTrigger</code>. å› ä¸ºåªéœ€è¦é€šçŸ¥å‡ºç°ä¸€æ¬¡,å°†<code>repeats</code>è®¾ç½®ä¸º <code>false</code>.</p>
<p>ç°åœ¨å·²ç»åˆ›å»ºå®Œè§¦å‘å™¨,æ¥ä¸‹æ¥çš„å°±æ˜¯åˆ›å»ºéœ€è¦åœ¨é€šçŸ¥ä¸­å±•ç¤ºçš„ <em>content</em>. è¿™å¯ä»¥é€šè¿‡ <code>UNMutableNotificationContent</code> ç±»å®Œæˆ. å°†ä¸‹é¢å‡ è¡Œä»£ç æ”¾åœ¨ <code>trigger</code> å˜é‡çš„ä¸‹é¢åˆ›å»ºé€šçŸ¥å†…å®¹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let content = UNMutableNotificationContent()</span><br><span class="line">content.title = &quot;Tutorial Reminder&quot;</span><br><span class="line">content.body = &quot;Just a reminder to read your tutorial over at appcoda.com!&quot;</span><br><span class="line">content.sound = UNNotificationSound.default()</span><br></pre></td></tr></table></figure>
<p>è¿™äº›ä»£ç å°±èƒ½ç†è§£å…¶å«ä¹‰:æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ <code>UNMutableNotificationContent</code> å®ä¾‹, ç„¶åè®¾ç½®å®ƒçš„æ ‡é¢˜, å†…å®¹, å£°éŸ³.</p>
<p>çœ‹èµ·æ¥å¥½åƒæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½å±•ç¤ºç¬¬ä¸€ä¸ªé€šçŸ¥äº†. ç„¶è€Œ,è¿˜å‰©ä¿©æ­¥éœ€è¦å®Œæˆ:1.åˆ›å»ºé€šçŸ¥<em>request</em>, 2.å°†å®ƒæä¾›ç»™ç³»ç»Ÿ,å‘Šè¯‰iOSå±•ç¤ºé€šçŸ¥.</p>
<p>ä¸ºäº†åˆ›å»ºé€šçŸ¥è¯·æ±‚,ç”¨ç›¸å…³çš„å†…å®¹å’Œè§¦å‘å™¨åˆå§‹åŒ–ä¸€ä¸ª <code>UNNotificationRequest</code> å¯¹è±¡.è¿˜éœ€è¦ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç ç”¨æ¥è¯†åˆ«è¿™ä¸ªé€šçŸ¥è¯·æ±‚. åœ¨ <code>scheduleNotification</code>å‡½æ•°ä¸­æ’å…¥ä¸‹é¢è¿™è¡Œä»£ç :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let request = UNNotificationRequest(identifier: &quot;textNotification&quot;, content: content, trigger: trigger)</span><br></pre></td></tr></table></figure></p>
<p>å¾ˆç®€å•,å¯¹ä¹ˆ?åˆ›å»ºè¯·æ±‚éœ€è¦3ä¸ªå‚æ•°:</p>
<ul>
<li><code>identifier</code>: è¿™æ˜¯æˆ‘ä»¬è¯·æ±‚çš„å”¯ä¸€æ ‡è¯†.ä½ å¾ˆå¿«å°±ä¼šçœ‹åˆ°,è¿™ä¸ªæ ‡è¯†èƒ½ç”¨æ¥å–æ¶ˆé€šçŸ¥è¯·æ±‚.</li>
<li><code>content</code>: è¿™æ˜¯ä¹‹å‰åˆ›å»ºçš„é€šçŸ¥å†…å®¹</li>
<li><code>trigger</code>: è¿™ä¸ªè§¦å‘å™¨ç”¨æ¥è§¦å‘é€šçŸ¥.å½“æ»¡è¶³è§¦å‘æ¡ä»¶å,iOSå°†ä¼šå±•ç¤ºè¿™ä¸ªé€šçŸ¥</li>
</ul>
<p>å¥½äº†,ç°åœ¨è¦åšçš„æœ€åä¸€ä»¶äº‹æ˜¯å°†è¯·æ±‚æ·»åŠ è¿›ç®¡ç†æ•´ä¸ªappæ‰€æœ‰é€šçŸ¥çš„é€šçŸ¥ä¸­å¿ƒ.é€šçŸ¥ä¸­å¿ƒä¼šæ ¹æ®åˆé€‚çš„æ—¶é—´è§¦å‘é€šçŸ¥.</p>
<p>å°†é€šçŸ¥è¯·æ±‚åŠ å…¥é€šçŸ¥ä¸­å¿ƒä¹‹å‰,æœ€å¥½å…ˆå°†å·²ç»å­˜åœ¨çš„é€šçŸ¥è¯·æ±‚ç§»é™¤, è¿™æ ·èƒ½å¤Ÿé¿å…é‡å¤é€šçŸ¥. å°†ä¸‹é¢çš„ä»£ç æ®µåŠ å…¥å‡½æ•°ä¸­:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">UNUserNotificationCenter.current().removeAllPendingNotificationRequests()</span><br><span class="line">UNUserNotificationCenter.current().add(request) &#123;(error) in</span><br><span class="line">    if let error = error &#123;</span><br><span class="line">        print(&quot;Uh oh! We had an error: \(error)&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€è¡Œä»£ç å¾—åˆ°é€šçŸ¥ä¸­å¿ƒçš„å•ä¾‹å¹¶è°ƒç”¨ <code>removeAllPendingNotificationRequests</code> æ–¹æ³•ç§»é™¤æ‰€æœ‰æŒ‚èµ·çš„é€šçŸ¥è¯·æ±‚.ç„¶åå°†è¯·æ±‚åŠ å…¥é€šçŸ¥ä¸­å¿ƒ.è¿™ä¸ªæ–¹æ³•ä¹Ÿåœ¨å‡½æ•°å®Œæˆåä¹Ÿä¼šè°ƒç”¨.åœ¨æˆ‘ä»¬å®ç°ä¸­,è¿™ä¸ªæ§åˆ¶å™¨ç”¨æ¥æ‰“å°é”™è¯¯. åœ¨ç»§ç»­æ“ä½œä¹‹å‰, ç¡®ä¿ <code>scheduleNotification</code> å‡½æ•°å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">func scheduleNotification(at date: Date) &#123;</span><br><span class="line">    let calendar = Calendar(identifier: .gregorian)</span><br><span class="line">    let components = calendar.dateComponents(in: .current, from: date)</span><br><span class="line">    let newComponents = DateComponents(calendar: calendar, timeZone: .current, month: components.month, day: components.day, hour: components.hour, minute: components.minute)</span><br><span class="line">    </span><br><span class="line">    let trigger = UNCalendarNotificationTrigger(dateMatching: newComponents, repeats: false)</span><br><span class="line">    </span><br><span class="line">    let content = UNMutableNotificationContent()</span><br><span class="line">    content.title = &quot;Tutorial Reminder&quot;</span><br><span class="line">    content.body = &quot;Just a reminder to read your tutorial over at appcoda.com!&quot;</span><br><span class="line">    content.sound = UNNotificationSound.default()</span><br><span class="line">    </span><br><span class="line">    let request = UNNotificationRequest(identifier: &quot;textNotification&quot;, content: content, trigger: trigger)</span><br><span class="line">    </span><br><span class="line">    UNUserNotificationCenter.current().removeAllPendingNotificationRequests()</span><br><span class="line">    UNUserNotificationCenter.current().add(request) &#123;(error) in</span><br><span class="line">        if let error = error &#123;</span><br><span class="line">            print(&quot;Uh oh! We had an error: \(error)&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœä»£ç å’Œä¸Šé¢çš„ä¸€æ ·,å‡†å¤‡å‡ºå‘å§! ç°åœ¨æˆ‘ä»¬éœ€è¦åšçš„æ˜¯åœ¨ <code>ViewController.swift</code>ä¸­é…ç½®å½“ç”¨æˆ·é€‰æ‹©æ—¶é—´åè°ƒç”¨<code>scheduleNotification(date:)</code> .åœ¨ <code>ViewController.swift</code>ä¸­,å°†ä¸‹é¢çš„ä»£ç åŠ å…¥<code>datePickerDidSelectNewDate</code> æ–¹æ³•ä¸­:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let selectedDate = sender.date</span><br><span class="line">let delegate = UIApplication.shared.delegate as? AppDelegate</span><br><span class="line">delegate?.scheduleNotification(at: selectedDate)</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„ä»£ç è·å–åˆ°äº†å½“å‰åº”ç”¨æ­£åœ¨ä½¿ç”¨çš„çš„<code>AppDelegate</code>å®ä¾‹å¹¶ç”¨ä¹‹å‰å†™çš„çš„å‡½æ•°å®šåˆ¶é€šçŸ¥.å¿«æ¥è¯•è¯•å§!è¿è¡Œappå¹¶é€‰æ‹©æœªæ¥çš„æ—¶é—´.ç­‰åˆ°è®¾å¤‡æ—¶é—´åˆ°é€‰æ‹©æ—¶é—´åçœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ!</p>
<p>å‘ƒ,é€šçŸ¥æ²¡å‡ºç°,ä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢?</p>
<p>è¿™æœ‰ä¸€äº›é€šçŸ¥æ²¡å‡ºç°çš„åŸå› .</p>
<p>é¦–å…ˆ,è‹¹æœè‡´åŠ›äºåœ¨iOSä¸Šä¿æŒä¸€ä¸ªå®Œç¾çš„ç”¨æˆ·ä½“éªŒ,ä½“éªŒçš„ä¸€éƒ¨åˆ†æ˜¯ç»™ç”¨æˆ·æä¾›ä»appå†…æ¥å—é€šçŸ¥çš„æ§åˆ¶æƒé™.ç”¨æˆ·è¿˜æ²¡æœ‰æˆæƒå±•ç¤ºé€šçŸ¥,è¿™å°±æ˜¯ä¸ºä»€ä¹ˆé€šçŸ¥æ²¡æœ‰å±•ç°çš„åŸå› .</p>
<p>è®©æˆ‘ä»¬ä¿®å¤è¿™ä¸ªé—®é¢˜.å°†ä¸‹é¢çš„ä»£ç åŠ å…¥ <code>AppDelegate.swift</code>çš„æ–¹æ³•ä¸­:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey : Any]? = nil) -&gt; Bool &#123;</span><br><span class="line">    </span><br><span class="line">    UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .sound]) &#123;(accepted, error) in</span><br><span class="line">        if !accepted &#123;</span><br><span class="line">            print(&quot;Notification access denied.&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œæˆ‘ä»¬è°ƒç”¨é€šçŸ¥ä¸­å¿ƒçš„<code>requestAuthorization</code>æ–¹æ³•æ¥è·å¾—ç”¨æˆ·ä½¿ç”¨é€šçŸ¥çš„è®¸å¯.æˆ‘ä»¬ä¹Ÿè¯·æ±‚å±•ç¤º<br>å‘Šè­¦å’Œå£°éŸ³çš„èƒ½åŠ›.</p>
<p>ç°åœ¨é‡æ–°è¿è¡Œapp.å½“appåŠ è½½å,ä½ ä¼šçœ‹è§æˆæƒè¯·æ±‚.ç¡®ä¿ä½ åŒæ„,ç„¶åappèƒ½å¤Ÿå‘è®¾å¤‡å‘é€é€šçŸ¥.</p>
<p>å¦ä¸€ä»¶ä½ éœ€è¦è®°ä½çš„æ˜¯,è¿™ä¸ªé€šçŸ¥ä¸ä¼šå†appå†…å±•ç¤º.å› æ­¤,ä¸€æ—¦ä½ è®¾ç½®äº†æ—¥æœŸ,ç¡®ä¿ä½ è¿”å›ä¸»å±å¹•å¹¶é”å±.<br>å¦‚æœæ‰€æœ‰æ­¥éª¤éƒ½å‡†ç¡®æ— è¯¯,é€šçŸ¥å°±ä¼šå‡ºç°å•¦!<br><img src="/img/14764376688190.jpg" alt=""></p>
<p>çœ‹è§æ²¡? å‘iOSç”¨æˆ·å‘é€é€šçŸ¥æ²¡é‚£ä¹ˆéš¾, åªéœ€è¦å…ˆæ‰§è¡Œä¸€äº›é¢„æç¤ºçš„æ­¥éª¤,ä¾‹å¦‚è¯·æ±‚é€šçŸ¥æƒé™.ç°åœ¨å·²ç»å‘é€äº†ç®€å•çš„æ–‡æœ¬,è®©æˆ‘ä»¬å†åŠ ä¸€å¼ å›¾ç‰‡!</p>
<h2 id="åœ¨é€šçŸ¥ä¸­é™„åŠ å›¾ç‰‡"><a href="#åœ¨é€šçŸ¥ä¸­é™„åŠ å›¾ç‰‡" class="headerlink" title="åœ¨é€šçŸ¥ä¸­é™„åŠ å›¾ç‰‡"></a>åœ¨é€šçŸ¥ä¸­é™„åŠ å›¾ç‰‡</h2><p>è¿™ä¸ªé€šçŸ¥ç°åœ¨æ˜¯åŸºäºæ–‡æœ¬.è¿™æ²¡å•¥æ–°é²œçš„! è®©æˆ‘ä»¬æ¢ç´¢ä¸€ä¸‹å…¶ä»–çš„ç‰¹å¾,ç±»ä¼¼äºåœ¨é€šçŸ¥ä¸­å±•ç¤ºå›¾ç‰‡.</p>
<p>åœ¨åˆå§‹å·¥ç¨‹ä¸­,æˆ‘å·²ç»ç»‘å®šäº†ä¸€å¼ å›¾ç‰‡:åä¸º <code>logo.png</code> .å¦‚æœä½ æ²¡çœ‹è§,å¯èƒ½æ˜¯å› ä¸ºå®ƒéšè—åœ¨<code>NotificationsUI</code>ç»„ä¸­äº†. æ— è®ºæ€æ ·,è¿™å¼ å›¾ç‰‡åœ¨åˆå§‹å·¥ç¨‹ä¸­. è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ€ä¹ˆå°†å®ƒå±•ç¤ºåœ¨é€šçŸ¥ä¸­.</p>
<p><code>UserNotification</code> æ¡†æ¶ä¸ºå¼€å‘è€…æä¾›äº†<code>UNNotificationAttachment</code>ç±»,ç”¨æ¥åœ¨é€šçŸ¥ä¸­æ·»åŠ é™„ä»¶.é™„ä»¶å¯ä»¥æ˜¯å½•éŸ³,å›¾ç‰‡å’ŒéŸ³é¢‘.ä»–ä¹Ÿæ”¯æŒè®¸å¤šæ–‡ä»¶æ ¼å¼. æ›´è¯¦ç»†çš„ä¿¡æ¯å¯è§çœ‹<a href="https://developer.apple.com/reference/usernotifications/unnotificationattachment" target="_blank" rel="external"> Apple Developer Website</a></p>
<p>å»ºç«‹ä¸€ä¸ªé™„ä»¶ç›¸å½“ç®€å•,åƒ<code>UserNotifications.framework</code> ä¸­çš„å¤§å¤šæ•°ä»»åŠ¡ä¸€æ ·. æˆ‘ä»¬åªéœ€è¦åˆå§‹åŒ–<code>UNNotificationAttachment</code> å®ä¾‹å¹¶æŠŠå®ƒåŠ åˆ°é€šçŸ¥å†…å®¹ä¸­.æ›´æ–° <code>scheduleNotification</code>æ–¹æ³•å¹¶å°†ä¸‹é¢çš„ä»£ç å—æ’å…¥åœ¨<code>request</code>å˜é‡å‰é¢.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if let path = Bundle.main.path(forResource: &quot;logo&quot;, ofType: &quot;png&quot;) &#123;</span><br><span class="line">    let url = URL(fileURLWithPath: path)</span><br><span class="line">    </span><br><span class="line">    do &#123;</span><br><span class="line">        let attachment = try UNNotificationAttachment(identifier: &quot;logo&quot;, url: url, options: nil)</span><br><span class="line">        content.attachments = [attachment]</span><br><span class="line">    &#125; catch &#123;</span><br><span class="line">        print(&quot;The attachment was not loaded.&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç åŠ è½½äº†logoå›¾ç‰‡çš„åœ°å€,è½¬åŒ–ä¸º<code>URL</code>,ç„¶åç”¨å›¾ç‰‡åˆå§‹åŒ–é™„ä»¶.<code>UNNotificationAttachment</code>çš„åˆå§‹åŒ–è¢«æ ‡è®°ä¸ºæŠ•æ·æ¡ä»¶, æ‰€ä»¥éœ€è¦ä¸€ä¸ª<code>catch</code>block è§£å†³é”™è¯¯.ä¸€æ—¦åˆ›å»ºå¥½é™„ä»¶,å°†å®ƒåŠ å…¥<code>content</code>ä¸­.é‡æ–°æµ‹è¯•app.ä¸€æ—¦åº”ç”¨åŠ è½½,é€‰æ‹©ä¸€ä¸ªæ—¥æœŸç­‰å¾…é€šçŸ¥å‡ºç°.</p>
<p><img src="/img/14764388175933.png" alt=""><br>å¤©å“ª!å¿«çœ‹,æˆ‘ä»¬å‘é€äº†ä¸€ä¸ªå¸¦å›¾ç‰‡çš„é€šçŸ¥.è¿™æ˜¯åœ¨iOS10ä¸­é¦–å…ˆæåˆ°çš„æ–°ç‰¹æ€§.è¿™ç‰¹åˆ«é…·,ä½†æˆ‘æƒ³å¦‚æœèƒ½åŠ ä¸€ä¸ª â€œç¨åæç¤ºâ€æŒ‰é’®å…è®¸ç”¨æˆ·æš‚æ—¶å¿½ç•¥è¿™ä¸ªæç¤ºä¼šæ›´å¥½.</p>
<p>ç°åœ¨å°±åšè¿™ä¸ªå§.</p>
<h2 id="ç”¨é€šçŸ¥çš„æ–¹æ³•æ·»åŠ ä¸€ä¸ªæç¤º"><a href="#ç”¨é€šçŸ¥çš„æ–¹æ³•æ·»åŠ ä¸€ä¸ªæç¤º" class="headerlink" title="ç”¨é€šçŸ¥çš„æ–¹æ³•æ·»åŠ ä¸€ä¸ªæç¤º"></a>ç”¨é€šçŸ¥çš„æ–¹æ³•æ·»åŠ ä¸€ä¸ªæç¤º</h2><p>æŒ‰ç…§APIä¸­è®¾å®šçš„æ–¹å¼,åœ¨é€šçŸ¥ä¸­åŠ å…¥ä¸€ä¸ªåŠŸèƒ½æœ‰ç‚¹å¤æ‚.ç„¶è€Œ,æ²¡ä»€ä¹ˆæ˜¯ä¸èƒ½è§£å†³çš„.ä¸ºäº†åœ¨é€šçŸ¥ä¸­åŠ å…¥ä¸€ä¸ªåŠŸèƒ½,éœ€è¦ä½¿ç”¨<code>UNNotificationAction</code>å’Œ<code>UNNotificationCategory</code>.</p>
<p>é¦–å…ˆ,éœ€è¦ä¸ºåŠŸèƒ½å®šä¹‰ä¸€ä¸ªç±»åˆ«<em>categories</em>. åªå®šä¹‰ä¸€ä¸ªç±»åˆ«å’Œä¸€ä¸ªåŠŸèƒ½.å°†ä¸‹é¢å‡ è¡Œä»£ç æ’å…¥<code>application(_:didFinishLaunchingWithOptions:)</code>æ–¹æ³•ä¸­<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let action = UNNotificationAction(identifier: &quot;remindLater&quot;, title: &quot;Remind me later&quot;, options: [])</span><br><span class="line">let category = UNNotificationCategory(identifier: &quot;myCategory&quot;, actions: [action], intentIdentifiers: [], options: [])</span><br><span class="line">UNUserNotificationCenter.current().setNotificationCategories([category])</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªåŠ¨ä½œä¸€ä¸ªç±»åˆ«,å¹¶ç”¨<code>UNNotificationCategory</code>ç™»è®°è¿™ä¸ªç±»åˆ«.</p>
<p>å¯èƒ½,ä½ ä¼šå¥½å¥‡ä¸ºä»€ä¹ˆä¼šå­˜åœ¨ç±»åˆ«. ä»–ä»¬ç”¨äºä¸åŒçš„ç›®çš„.å°†ä¸€ä¸ªç±»åˆ«æƒ³è±¡ä¸ºä¸€ç»„åŠŸèƒ½,ä¸€æ—¦åˆ›å»º,å°±èƒ½å¤Ÿåœ¨<code>UNNotificationContent</code> ä¸­ä¸ºé€šçŸ¥æ·»åŠ ä¸€ä¸ªç±»åˆ«, è¿™ä¸ªç±»åˆ«ä¸­åŒ…å«çš„æ‰€æœ‰åŠŸèƒ½éƒ½ä¼šå±•ç¤ºåœ¨è¿™ä¸ªé€šçŸ¥ä¸­</p>
<p>åœ¨è¿™ä¸ªdemoä¸­,ç±»åˆ«é‡Œé¢åªæœ‰ä¸€ä¸ªåŠŸèƒ½; ä½†å¦‚æœæˆ‘ä»¬è®¸å¤šåŠŸèƒ½,å°†å®ƒä»¬èµ‹å€¼ç»™ç±»ä¼šä½¿ä»–ä»¬éƒ½å¾—åˆ°ä½¿ç”¨.è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè‹¹æœçš„å·¥ç¨‹å¸ˆæä¾›äº†<code>UNNotificationCategory</code>æ¥ç®¡ç†é€šçŸ¥çš„åŠŸèƒ½.</p>
<p>ç°åœ¨åˆ›å»ºäº†ä¸€ä¸ªåŠŸèƒ½ä¸€ä¸ªç±»åˆ«å¹¶ä¸”ç™»è®°äº†è¿™ä¸ªç±»åˆ«,ä½¿ç”¨å®ƒ.æ›´æ”¹åˆ›å»º<code>content</code>çš„è¿™éƒ¨åˆ†ä»£ç ç„¶ååŠ å…¥ä¸‹é¢çš„:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content.categoryIdentifier = &quot;myCategory&quot;</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ˜¯å‘Šè¯‰ç³»ç»Ÿæˆ‘ä»¬æƒ³åœ¨æ–°çš„é€šçŸ¥ä¸­ä½¿ç”¨<code>myCategory</code>.ç°åœ¨,ç¼–è¯‘å¹¶é‡æ–°è¿è¡Œappçœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ:<br><img src="/img/14764404214267.png" alt=""><br>å¤ªå¸…äº†! æˆ‘ä»¬çš„é€šçŸ¥ç°åœ¨æœ‰äº†ä¸€ä¸ªå¯çˆ±çš„æŒ‰é’®.ä½†æ˜¯å¦‚æœä½ ç‚¹å‡»è¿™ä¸ªæŒ‰é’®,å®ƒåªæ˜¯è®©é€šçŸ¥æ¶ˆå¤±äº†.å‰©ä¸‹éœ€è¦åšçš„æ˜¯ç¼–å†™ç›¸åº”è¿™ä¸ªåŠ¨ä½œçš„ä»£ç .</p>
<p><code>UNUserNotificationCenterDelegate</code>åè®®å®šä¹‰äº†é€šçŸ¥å›è°ƒçš„æ–¹æ³•.æ‰€ä»¥,ä¸ºäº†å“åº”è¿™ä¸ªåŠ¨ä½œ,è®©æˆ‘ä»¬æ‰©å±•<code>AppDelegate</code>æ¥å®ç°<code>UNUserNotificationCenterDelegate</code>è¿™ä¸ªåè®®.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">extension AppDelegate: UNUserNotificationCenterDelegate &#123;</span><br><span class="line">    func userNotificationCenter(_ center: UNUserNotificationCenter, didReceive response: UNNotificationResponse, withCompletionHandler completionHandler: @escaping () -&gt; Void) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>userNotificationCenter(_:didReceive:withCompletionHandler:)</code>æ–¹æ³•ä¼šåœ¨ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªåŠ¨ä½œåè°ƒç”¨.ä½ èƒ½é€šè¿‡å·²ç»™çš„<code>UNNotificationResponse</code>çš„<code>actionIdentifier</code>è·å¾—ç”¨æˆ·é€‰æ‹©çš„åŠ¨ä½œ.è®©æˆ‘ä»¬å®Œæˆè¿™ä¸ªæ–¹æ³•:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func userNotificationCenter(_ center: UNUserNotificationCenter, didReceive response: UNNotificationResponse, withCompletionHandler completionHandler: @escaping () -&gt; Void) &#123;</span><br><span class="line"> </span><br><span class="line">    if response.actionIdentifier == &quot;remindLater&quot; &#123;</span><br><span class="line">        let newDate = Date(timeInterval: 900, since: Date())</span><br><span class="line">        scheduleNotification(at: newDate)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç å®šåˆ¶äº†ä¸€ä¸ªå½“å‰æ—¶é—´ä¹‹åçš„900ç§’(60s * 15 min)çš„æ–°é€šçŸ¥.æœ€å,åœ¨ <code>scheduleNotification(at:)</code>æ–¹æ³•ä¸­è®¾ç½®é»˜è®¤çš„é€šçŸ¥ä¸­å¿ƒçš„ä»£ç†ä¸º<code>AppDelegate</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UNUserNotificationCenter.current().delegate = self</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨é‡æ–°è¿è¡Œè¿™ä¸ªappå¹¶å®šåˆ¶ä¸€ä¸ªé€šçŸ¥æ¥æµ‹è¯•å®ƒä»¬.å½“é€šçŸ¥å‡ºç°å,ç‚¹å‡»<code>Remind me later</code>æŒ‰é’®.<br>ä½ ä¼šåœ¨15åˆ†é’Ÿä¹‹åæ”¶åˆ°å¦ä¸€ä¸ªé€šçŸ¥.</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘å¸Œæœ›ä½ å–œæ¬¢è¿™ä¸ªå…³äºç”¨æˆ·é€šçŸ¥æ¡†æ¶çš„æŒ‡å¯¼æ•™ç¨‹.åœ¨ç¬¬äºŒéƒ¨åˆ†,æˆ‘ä»¬ä¼šæ›´æ·±å…¥çš„è®¨è®ºé€šçŸ¥å¹¶å­¦ä¹ åœ¨é€šçŸ¥ä¸­æ¤å…¥è‡ªå®šä¹‰çš„è§†å›¾æ§åˆ¶å™¨.</p>
<p>ä½ å¯ä»¥åœ¨Githubä¸Šä¸‹è½½è¿™ä»½æ•™ç¨‹çš„<a href="https://github.com/appcoda/NotificationsUI-Demo" target="_blank" rel="external">demoå·¥ç¨‹</a></p>
<p><strong>å£°æ˜</strong>: </p>
<ul>
<li>åŸè‹±æ–‡æ–‡ç« æ¥æºäºappcoda,æœ¬äººä»…ä½œä¸ªäººå­¦ä¹ ä½¿ç”¨;è‹¥ä¾µçŠ¯äº†åŸä½œè€…æƒç›Š,ç«‹å³åˆ é™¤</li>
<li>æœ¬äººè‹±è¯­æ°´å¹³æœ‰é™,æ–‡ç« ä¸­è‹¥æœ‰ç¿»è¯‘ä¸Šçš„é”™è¯¯,è¿˜è¯·æŒ‡æ­£(<a href="&#109;&#97;&#x69;&#x6c;&#x74;&#x6f;&#58;&#120;&#x69;&#x61;&#x71;&#105;&#110;&#x67;&#48;&#56;&#x32;&#48;&#x40;&#x31;&#54;&#x33;&#x2e;&#99;&#x6f;&#109;">&#120;&#x69;&#x61;&#x71;&#105;&#110;&#x67;&#48;&#56;&#x32;&#48;&#x40;&#x31;&#54;&#x33;&#x2e;&#99;&#x6f;&#109;</a>)</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/10/17/iOS10ç”¨æˆ·é€šçŸ¥æ¡†æ¶-User-Notifications-ç®€ä»‹-ç¿»è¯‘/" data-id="ciytk1eru0003psux2rnmjl71" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-åœ¨Xcode7ä¸­ä½¿ç”¨Swiftè¿›è¡Œå•å…ƒæµ‹è¯•" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/21/åœ¨Xcode7ä¸­ä½¿ç”¨Swiftè¿›è¡Œå•å…ƒæµ‹è¯•/" class="article-date">
  <time datetime="2016-09-21T02:16:17.000Z" itemprop="datePublished">2016-09-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/21/åœ¨Xcode7ä¸­ä½¿ç”¨Swiftè¿›è¡Œå•å…ƒæµ‹è¯•/">åœ¨Xcode7ä¸­ä½¿ç”¨Swiftè¿›è¡Œå•å…ƒæµ‹è¯•</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>iOS ç¨‹åºå‘˜ç»å¸¸éœ€è¦debugè‡ªå·±çš„app,é™¤éä½ æ˜¯é‚£ç§ç–¯ç‹‚çš„ç¨‹åºå¤§ç¥,ä¸ç„¶ä¸€å®šä½“ä¼šè¿‡å‡ ä¸ªå°æ—¶å‡ ä¸ªå°æ—¶æ‰¾Bugæœ€åå´å‘ç°åªæ˜¯å˜é‡å£°æ˜æœ‰è¯¯æ—¶å€™é‚£ç§ç»æœ›çš„å¿ƒæƒ….æ¯”è¿™æ›´ç³Ÿç³•çš„æ˜¯,å‡ ä¸ªå°æ—¶ä¹Ÿæ²¡æ‰¾åˆ°Bugçš„åŸå› . æ— è®ºä½ æ˜¯ç¨‹åºæ–°äººè¿˜æ˜¯å¼€å‘è¿‡è®¸å¤šappçš„ç¨‹åºå‘˜,è§„èŒƒçš„ç¼–å†™å•å…ƒæµ‹è¯•èƒ½å¤Ÿä½¿ä»£ç æ›´å¯é ,å®‰å…¨ä¸”å®¹æ˜“æ£€æŸ¥.</p>
<p>å¹¸è¿çš„æ˜¯,Xcode7å’ŒSwiftæ”¯æŒå•å…ƒæµ‹è¯•.è™½ç„¶å†™äº†å•å…ƒæµ‹è¯•å¹¶ä¸ä»£è¡¨ç¨‹åºæ²¡Bug, å®ƒä»ç„¶æ˜¯æ£€æŸ¥ä»£ç ç‰‡æ®µæŒ‰é¢„æœŸæ‰§è¡Œå¹¶ä½¿debugå®¹æ˜“äº›çš„ç›¸å½“æœ‰æ•ˆçš„æ–¹æ³•.</p>
<p>å¦‚åå­—é‚£æ ·,åœ¨å•å…ƒæµ‹è¯•ä¸­,ä¼šå¯¹æŒ‡å®šçš„ä»£ç ç‰‡æ®µå»ºç«‹å°çš„æœ‰é’ˆå¯¹æ€§çš„æµ‹è¯•å‡½æ•°,ä»¥ç¡®ä¿æ¯æ®µä»£ç éƒ½å¯ä»¥é€šè¿‡æµ‹è¯•.å¦‚æœæµ‹è¯•é€šè¿‡,åœ¨å‡½æ•°æ—è¾¹ä¼šå‡ºç°ç»¿è‰²çš„æ ‡å¿—.å¦‚æœæµ‹è¯•æ²¡æœ‰é€šè¿‡,æ— è®ºå¤±è´¥åŸå› æ˜¯ä»€ä¹ˆ,Xcodeéƒ½ä¼šå°†ä»£ç æ ‡è®°ä¸ºå¤±è´¥.è¿™è¡¨ç¤ºä½ éœ€è¦åœ¨ä»£ç ä¸­æŸ¥æ‰¾äº§ç”Ÿé”™è¯¯çš„åŸå› </p>
<h2 id="Demoæ¦‚è§ˆ"><a href="#Demoæ¦‚è§ˆ" class="headerlink" title="Demoæ¦‚è§ˆ"></a>Demoæ¦‚è§ˆ</h2><p>é¦–å…ˆ,åœ¨<a href="http://www.appcoda.com/unit-testing-swift/" target="_blank" rel="external">è¿™é‡Œ</a>ä¸‹è½½æˆ‘å·²ç»åˆ›å»ºå¥½çš„å·¥ç¨‹,è¿™æ˜¯ä¸ªç®€å•çš„ç”¨æ•°å€¼å’Œç™¾åˆ†æ¯”è¿›è¡Œç™¾åˆ†æ¯”è®¡ç®—çš„åº”ç”¨.(exp:10% * 80 = 8)</p>
<p>è¿™ä¸ªç™¾åˆ†æ¯”è®¡ç®—å™¨ç›¸å½“ç®€å•.ä½ ä¸»è¦çœ‹ViewController.swiftè¿™ä¸ªæ–‡ä»¶, æ–‡ä»¶ä¸­çš„ä»£ç æ³¨é‡Šçš„å¾ˆé€šä¿—æ˜“æ‡‚.</p>
<p>å·¥ç¨‹ä¸­ä¸€å…±æœ‰5å¯¹å…³è”å…³ç³»:æ¯ä¸€ä¸ªå…³ç³»å¯¹åº”ç•Œé¢ä¸Šçš„ä¸€ä¸ªUIå…ƒç´ ,é™¤æ ‡é¢˜å¤–,è¿˜æœ‰ä¿©ä¸ªIBActionså¯¹åº”ä¿©ä¸ªSlider,æ¯ä¸ªIBActionçš„åç§°å‡†ç¡®è§£é‡Šäº†è¿™ä¸ªæ–¹æ³•éœ€è¦æ‰§è¡Œçš„åŠ¨ä½œ.å½“ä¿©ä¸ªæ»‘å—ä¸­çš„ä»»ä¸€ä¸ªæ”¹å˜æ—¶,ç™¾åˆ†æ¯”å’Œæ•°å€¼è·Ÿç€ä¸€èµ·æ”¹å˜</p>
<p>æ­¤å¤–,è¿˜æœ‰ä¿©ä¸ªç®€å•çš„å‡½æ•° <code>updateLabels()</code> å’Œ <code>percentage()</code> ç”¨æ¥æ‰§è¡Œä½ æƒ³è¦å®Œæˆçš„åŠ¨ä½œ:ç¬¬ä¸€ä¸ªå‡½æ•°æ›´æ–°æ»‘å—æ»‘åŠ¨æ—¶å±•ç¤ºçš„æ•°å€¼,ç¬¬äºŒä¸ªå‡½æ•°ä¼ å…¥ä¿©ä¸ªæµ®ç‚¹å‹æ•°å€¼å¹¶è¿”å›ç™¾åˆ†æ¯”è®¡ç®—ç»“æœ.</p>
<p>åœ¨æ¨¡æ‹Ÿå™¨ä¸­è¿è¡Œapp. åˆšå¼€å§‹æ—¶å€™,ä¸€åˆ‡æ­£å¸¸.ä½†åªè¦ä½ å¼€å§‹æ›´æ–°æ•°å€¼,å°±ä¼šå‘ç°è®¡ç®—ç»“æœä¸å¯¹.ä¸ºäº†æ‰¾åˆ°è¿™ä¸ªBug,æˆ‘ä»¬å¯ä»¥å°†ä»£ç åˆ†æˆå‡ ä¸ªå•å…ƒå¹¶åˆ†å¼€æµ‹è¯•ä»¥æ£€æŸ¥å„éƒ¨åˆ†æ˜¯å¦æŒ‰ç…§é¢„æœŸæ‰§è¡Œ. è¿™æ ·åšå¹¶ä¸ä¼šè§£å†³Bug, ä½†èƒ½å¤Ÿç¼©å°ä½ æ‰¾Bugçš„èŒƒå›´.</p>
<p><img src="/img/unit-test-demo-app.png" alt="unit-test-demo-app"></p>
<p>åˆ›å»ºå·¥ç¨‹æ—¶,æˆ‘é€‰äº†é»˜è®¤åŒ…å«æµ‹è¯•æ–‡ä»¶.(å¦‚æœä½ æƒ³æ‰‹åŠ¨æ·»åŠ æ–‡ä»¶,åœ¨iOSèµ„æºæ–‡ä»¶ä¸­ä¾æ¬¡ç‚¹å‡» File &gt; New &gt; File &gt; Unit Test Case).æ­¤å¤„,æµ‹è¯•æ–‡ä»¶å·²ç»ç”±Xcodeå»ºå¥½,å¯ä»¥åœ¨ å¯¼èˆªå™¨çš„<code>PercentageCalculatorTests</code> æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°<br><img src="/img/xcode-unit-test-option.png" alt="xcode-unit-test-option"></p>
<p>åœ¨<code>PercentageCalculatorTests.swift</code>æ–‡ä»¶ä¸­,ç±» <code>PercentageCalculatorTests</code> é‡Œé¢å·²ç»åˆ›å»ºäº†4ä¸ªæ–¹æ³•. å…¶ä¸­ä¿©ä¸ªæ˜¯ç¤ºä¾‹,å¯ä»¥åˆ é™¤(å¯ä»¥é€šè¿‡å…³é”®å­—<code>test</code>æ‰¾åˆ°,å¹¶ä¸”åœ¨æ–¹æ³•çš„åºå·åˆ—å·¦ä¾§æœ‰ä¸ªæ–¹å—å½¢icon,åç§°ä»¥ <code>Example</code> ç»“å°¾).å¦ä¿©ä¸ªå‡½æ•°: <code>setUp()</code> å’Œ <code>tearDown()</code> æ˜¯ä¸“é—¨ç”¨äºæµ‹è¯•çš„,åœ¨æµ‹è¯•æ–¹æ³•æ‰§è¡Œå‰åä¼šä¾æ¬¡è°ƒç”¨.</p>
<h2 id="å¼€å§‹ç¼–å†™å•å…ƒæµ‹è¯•"><a href="#å¼€å§‹ç¼–å†™å•å…ƒæµ‹è¯•" class="headerlink" title="å¼€å§‹ç¼–å†™å•å…ƒæµ‹è¯•"></a>å¼€å§‹ç¼–å†™å•å…ƒæµ‹è¯•</h2><p>ç°åœ¨,å°†è¦å¼€å§‹å†™ä½ çš„ç¬¬ä¸€ä¸ªå•å…ƒæµ‹è¯•!è¿™ä¸ªæ•™ç¨‹ä¸­,åªæµ‹è¯•ç±» <code>ViewController</code> . æˆ‘ä»¬éœ€è¦åœ¨ <code>PercentageCalculatorTests</code> æ·»åŠ ä¸€ä¸ªå®ä¾‹.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class PercentageCalculatorTests: XCTestCase &#123;</span><br><span class="line">    var vc: ViewController!</span><br><span class="line">    </span><br><span class="line">    override func setUp() &#123;</span><br><span class="line">        super.setUp()</span><br><span class="line">        // Put setup code here. This method is called before the invocation of  each test method in the class.</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override func tearDown() &#123;</span><br><span class="line">        // Put teardown code here. This method is called after the invocation of each test method in the class.</span><br><span class="line">        super.tearDown()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±» <code>PercentageCalculatorTests</code> ç»§æ‰¿äº <code>XCTestCase</code>. å®ƒåŒ…å«äº† <code>XCTest</code>æ¡†æ¶. æ¯ä¸ª<code>XCTestCase</code> å­ç±»çš„å®ä¾‹è´Ÿè´£æµ‹è¯•å·¥ç¨‹ä¸­æŒ‡å®šçš„ä¸€éƒ¨åˆ†,ä¾‹å¦‚ä¸€ä¸ªç‰¹æ®Šçš„ç‰¹ç‚¹.</p>
<p>å› ä¸º <code>setup</code> åœ¨æ‰€æœ‰æµ‹è¯•æ–¹æ³•ä¹‹å‰è°ƒç”¨, åœ¨<code>setup</code>æ–¹æ³•ä¸­åˆå§‹åŒ– <code>vc</code> , è¿™æ ·å¯ä»¥åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•ä¸­è·å¾—ä¸€ä¸ªæ–°çš„ <code>ViewController</code> å®ä¾‹. åƒä¸‹é¢çš„ä»£ç ä¸€æ ·æ›´æ–° <code>setUp</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">override func setUp() &#123;</span><br><span class="line">    super.setUp()</span><br><span class="line"> </span><br><span class="line">    let storyboard = UIStoryboard(name: &quot;Main&quot;, bundle: NSBundle.mainBundle())</span><br><span class="line">    vc = storyboard.instantiateInitialViewController() as! ViewController</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®°ä½æ‰€æœ‰çš„æµ‹è¯•æ–¹æ³•éƒ½ä»¥å…³é”®å­— <code>test</code> å¼€å¤´,å¦åˆ™Xcodeä¸è¯†åˆ«. æ·»åŠ ä¸€ä¸ªæ–°æ–¹æ³• <code>testPercentageCalculator</code> ç”¨æ¥ç¡®è®¤ <code>ViewController</code> ä¸­çš„<code>percentage()</code>æ–¹æ³•æ˜¯å¦æ­£å¸¸è¿è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">func testPercentageCalculator() &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å•å…ƒæµ‹è¯•æ—¶è¦æ£€æŸ¥æŸä¸€å¤§å—ä»£ç æ˜¯å¦æ­£å¸¸è¿è¡Œ. è¿™ä¸€å¤§å—ä»£ç é€šå¸¸åªéœ€è¦å‡ è¡Œå…¸å‹çš„ä»£ç æ¥æµ‹è¯•,ä½ åªæµ‹è¯•ä¸€ä¸ªæ–¹æ³•æˆ–å‡½æ•°. å•å…ƒæµ‹è¯•é€šè¿‡ç»™ä¸€éƒ¨åˆ†ä»£ç æä¾›ä¸€ä¸ªå…¥å‚,ç”¨è¿™ä¸ªæ‰§è¡Œä»£ç ,ç„¶åæ£€æŸ¥è¿”å›å‚æ•°æ˜¯ä¸æ˜¯ä¸æˆ‘ä»¬é¢„æœŸçš„ç›¸ç¬¦åˆ<br><img src="/img/Example.png" alt="Example"></p>
<p>æ¯”è¾ƒæˆ‘ä»¬é¢„æœŸç»“æœæ˜¯å¦æ­£ç¡®è¿™éƒ¨åˆ†ç”± <code>XCTAssert</code>å‡½æ•°å®Œæˆ. æœ€ç®€å•çš„<code>XCTAssert</code> å‡½æ•°ä¸º<code>XCTAssert(expression: BooleanType)</code>,éœ€è¦ä¼ å…¥BOOLè¡¨è¾¾å¼(exp: <code>5 &gt; 3</code>, <code>8.90 == 8.90</code> or <code>true</code>),å‡½æ•°è¿”å›çœŸæˆ–å‡ä½¿å¾—æµ‹è¯•é€šè¿‡.</p>
<p>å¿«æ¥è¯•è¯•å§!é¦–å…ˆ,åœ¨æ–¹æ³•<code>testPercentageCalculator()</code>ä¸­åŠ å…¥ä¸‹é¢è¿™è¡Œ.ç„¶å,å°†é¼ æ ‡ç§»åŠ¨åˆ°æ–¹æ³•åå·¦è¾¹çš„è±å½¢å—å›¾æ ‡å¤„,é¼ æ ‡æ¥å›ç§»åŠ¨,iconå˜æˆä¸€ä¸ªå¯è¿è¡Œçš„iconç„¶åç‚¹å‡»å¼€å§‹æµ‹è¯•.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func testPercentageCalculator() &#123;</span><br><span class="line">        XCTAssert(true)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœè¿è¡Œé¡ºåˆ©,æµ‹è¯•é€šè¿‡,æ–¹æ³•æ—è¾¹å‡ºç°ä¸€ä¸ªç»¿è‰²çš„å¯¹å·.<br><img src="/img/unit-test-green-mark.png" alt="unit-test-green-mark"></p>
<h2 id="æ£€æŸ¥ç™¾åˆ†æ¯”è®¡ç®—ç»“æœ"><a href="#æ£€æŸ¥ç™¾åˆ†æ¯”è®¡ç®—ç»“æœ" class="headerlink" title="æ£€æŸ¥ç™¾åˆ†æ¯”è®¡ç®—ç»“æœ"></a>æ£€æŸ¥ç™¾åˆ†æ¯”è®¡ç®—ç»“æœ</h2><p>ç°åœ¨å¼€å§‹åŠ¨çœŸæ ¼äº†:æµ‹è¯•<code>percentage()</code>æ–¹æ³•. é€šè¿‡ <code>vc</code>å±æ€§è°ƒç”¨è¿™ä¸ªæ–¹æ³•, <code>vc</code>æ˜¯<code>ViewController</code> çš„ä¸€ä¸ªå®ä¾‹. ä¼ ä¿©ä¸ªæµ®ç‚¹å€¼ 50 å’Œ 50 ,ç”¨é™æ€å€¼<code>p</code>ä¿å­˜ç»“æœ. åœ¨è¿™é‡Œ, <code>p</code>åº”è¯¥ç­‰äº25 (50 * 50% = 25),æ£€æŸ¥è¿™ä¸ªç”¨ä¾‹ <code>XCTAssert(p == 25)</code>å¹¶æ‰§è¡Œæµ‹è¯•æ–¹æ³•. ç”¨ä¸‹é¢çš„ä»£ç æ›¿æ¢<code>testPercentageCalculator()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func testPercentageCalculator() &#123;</span><br><span class="line">        // Should be 25</span><br><span class="line">        let p = vc.percentage(50, 50)</span><br><span class="line">        XCTAssert(p == 25)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•é€šè¿‡,æ„å‘³ç€<code>ViewController</code> çš„ å‡½æ•° <code>percentage()</code>æ­£å¸¸æ‰§è¡Œ, éœ€è¦åœ¨å…¶ä»–åœ°æ–¹æ‰¾    bugåŸå› . å¯èƒ½åœ¨ <code>updateLabels()</code> æ–¹æ³•ä¸­</p>
<h2 id="æ£€æŸ¥Label"><a href="#æ£€æŸ¥Label" class="headerlink" title="æ£€æŸ¥Label"></a>æ£€æŸ¥Label</h2><p>æ·»åŠ ä¸€ä¸ªæ–°çš„æµ‹è¯•æ–¹æ³• <code>testLabelValuesShowedProperly()</code> ç”¨æ¥æ£€æŸ¥Labelä¸Šçš„å†…å®¹æ˜¯å¦æ­£ç¡®.ç„¶åä»ViewControllerä¸­è°ƒç”¨æ–¹æ³• <code>updateLabels()</code>,è¿™æ¬¡, æˆ‘ä»¬æ£€æŸ¥æ¯ä¸ªLabelä¸Šçš„textå±æ€§å’Œæˆ‘ä»¬æƒ³è¦å±•ç¤ºçš„ä¸œè¥¿æ˜¯å¦ç›¸ç¬¦.</p>
<p>è®°å¾—ä½ ç»™ <code>XCTAssert</code>å‡½æ•°ä¸€ä¸ªæ–°çš„å‚æ•°:å­—ç¬¦ä¸²æ¶ˆæ¯. è¿™æ ·å¾ˆæ–¹ä¾¿,å› ä¸ºæˆ‘ä»¬æœ‰å¤šä¸ª(è°ƒç”¨<code>XCTAssert</code>ä¸‰æ¬¡)éœ€è¦å®Œæˆæ£€æµ‹çš„å€¼. å¦‚æœæµ‹è¯•ä¸æˆåŠŸ,è¿™ä¸ªæ¶ˆæ¯ä¼šå‘Šè¯‰æˆ‘ä»¬åˆ°åº•å“ªé‡Œæœ‰é—®é¢˜.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func testLabelValuesShowedProperly() &#123;</span><br><span class="line">        vc.updateLabels(Float(80.0), Float(50.0), Float(40.0))</span><br><span class="line">        </span><br><span class="line">        // The labels should now display 80, 50 and 40</span><br><span class="line">        XCTAssert(vc.numberLabel.text == &quot;80.0&quot;, &quot;numberLabel doesn&apos;t show the right text&quot;)</span><br><span class="line">        XCTAssert(vc.percentageLabel.text == &quot;50.0%&quot;, &quot;percentageLabel doesn&apos;t show the right text&quot;)</span><br><span class="line">        XCTAssert(vc.resultLabel.text == &quot;40.0&quot;, &quot;resultLabel doesn&apos;t show the right text&quot;)</span><br></pre></td></tr></table></figure>
<p>å½“ä½ è¦æ‰§è¡Œè¿™ä¸ªæ–¹æ³•æ—¶,ä½ ä¼šå¾—åˆ°<code>numberLabel</code>,<code>percentageLabel</code>,<code>resultsLabel</code>ä¸º<code>nil</code>çš„é”™è¯¯ä¿¡æ¯.è¿™æ€ä¹ˆå¯èƒ½?</p>
<p>è¿™æ˜¯å› ä¸ºæˆ‘åœ¨Storyboardæ–‡ä»¶ä¸­åˆ›å»ºçš„Label,å› æ­¤ä»–ä»¬ä»…åœ¨è§†å›¾åŠ è½½æ—¶è°ƒç”¨ä¸€æ¬¡.ä½†æ˜¯å•å…ƒæµ‹è¯•ä¸­<code>loadView()</code>æ–¹æ³•æ°¸ä¸æ‰§è¡Œ, æ‰€ä»¥Labelæ²¡æœ‰è¢«åˆ›å»ºä»–ä»¬éƒ½æ˜¯<code>nil</code>. è¿™ä¸ªé—®é¢˜æœ‰ä¸€ä¸ªè§£å†³åŠæ³•æ˜¯è°ƒç”¨<code>vc.loadView()</code> ,ä½†è‹¹æœåœ¨å®˜æ–¹æ–‡æ¡£ä¸­ä¸å»ºè®®è¿™æ ·åš,å› ä¸ºè§†å›¾å·²ç»åŠ è½½åå†åŠ è½½ä¸€éå¯èƒ½ä¼šå¼•èµ·å†…å­˜æ³„æ¼.</p>
<p>ä½ åº”è¯¥è·å¾—<code>vc</code>çš„å±æ€§<code>view</code>,ä»–ä¼šæŒ‰é¡ºåºè§¦å‘éœ€è¦çš„æ–¹æ³•,è€Œä¸ä»…ä»…æ˜¯<code>loadView()</code>.åœ¨<code>testLabelValuesShowedProperly()</code>ä¸­æ›´æ–°ä»£ç .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func testLabelValuesShowedProperly() &#123;</span><br><span class="line">        let _ = vc.view</span><br><span class="line">        vc.updateLabels(Float(80.0), Float(50.0), Float(40.0))</span><br><span class="line">        </span><br><span class="line">        // The labels should now display 80, 50 and 40</span><br><span class="line">        XCTAssert(vc.numberLabel.text == &quot;80.0&quot;, &quot;numberLabel doesn&apos;t show the right text&quot;)</span><br><span class="line">        XCTAssert(vc.percentageLabel.text == &quot;50.0%&quot;, &quot;percentageLabel doesn&apos;t show the right text&quot;)</span><br><span class="line">        XCTAssert(vc.resultLabel.text == &quot;40.0&quot;, &quot;resultLabel doesn&apos;t show the right text&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨ä¸‹æ»‘çº¿(_)é»˜è®¤ä¸€ä¸ªå¸¸é‡åç§°,å› ä¸ºæˆ‘ä»¬å¹¶ä¸éœ€è¦è¿™ä¸ªviewè€Œä¸”ä¹Ÿä¸ä¼šç”¨åˆ°å®ƒ.å®ƒåªæ˜¯å‘Šè¯‰ç¼–è¯‘å™¨â€å‡è£…è·å¾—äº†è¿™ä¸ªè§†å›¾å¹¶è§¦å‘æ–¹æ³•â€</p>
<p>æ‰§è¡Œè¿™ä¸ªæµ‹è¯•(å¦‚æœä½ æƒ³æ‰§è¡Œæµ‹è¯•ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•,ä½ å¯ä»¥ç‚¹å‡»<code>class PercentageCalculatorTests</code>æ—è¾¹çš„æ–¹å½¢)<br><img src="/img/unit-test-demo-fail.png" alt="unit-test-demo-fai"></p>
<h2 id="ä¿®å¤Bug"><a href="#ä¿®å¤Bug" class="headerlink" title="ä¿®å¤Bug"></a>ä¿®å¤Bug</h2><p>å¦‚ä½ æ‰€è§,æµ‹è¯•å¤±è´¥!å…·ä½“çš„é”™è¯¯ä¿¡æ¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç¡®å®šå¯èƒ½å¼•èµ·Bugçš„åŸå› . ç»“æœå‘Šè¯‰æˆ‘ä»¬resultsLabelæ²¡æœ‰è¿”å›æ­£ç¡®çš„text.è®©æˆ‘ä»¬è¿›åˆ°ViewControlleræ£€æŸ¥è¿™äº›Labelçš„æ˜¯æ€ä¹ˆè¢«èµ‹å€¼çš„.åœ¨æ·±å…¥æ£€æŸ¥<code>ViewController.swift</code> ä¸­çš„<code>updateLabels()</code>ä»£ç å,å¯ä»¥å‘ç°å› ä¸ºBugçš„åŸå› :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.resultLabel.text = &quot;\(rV + 10)&quot;</span><br></pre></td></tr></table></figure>
<p>åº”è¯¥ä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.resultLabel.text = &quot;\(rV)&quot;</span><br></pre></td></tr></table></figure>
<p>æ›´æ–°ä»£ç ç„¶åå†æ¬¡æµ‹è¯•.ä¸‡äº‹é¡ºåˆ©!</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨è¿™ä¸ªæ•™ç¨‹ä¸­,å­¦ä¹ äº†Xcodeä¸­çš„å•å…ƒæµ‹è¯•ä»¥åŠå•å…ƒæµ‹è¯•æ€ä¹ˆå¸®åŠ©ä½ åœ¨ä»£ç ä¸­æ‰¾åˆ°Bug.é™¤äº†å‡å°‘Bug,å•å…ƒæµ‹è¯•èƒ½ç”¨æ¥æ€§èƒ½æµ‹è¯•å’Œå¼‚æ­¥æµ‹è¯•. å…¶ä»–å¸å¼•äººçš„éƒ¨åˆ†æ˜¯UIæµ‹è¯•,èƒ½é€šè¿‡è®°å½•åŠ¨ä½œåœ¨appä¸­è¿˜åŸçœŸå®åœºæ™¯çš„è¡¨ç°.å¦‚æœè¿™å¬èµ·æ¥å¾ˆæœ‰æ„æ€,ä½ çœŸè¯¥å¥½å¥½çœ‹çœ‹<a href="https://developer.apple.com/videos/play/wwdc2015-406/" target="_blank" rel="external">è¿™éƒ¨åˆ†å…³äºUIæµ‹è¯•çš„è§†é¢‘</a></p>
<p>å®Œæ•´ä»£ç ,å¯ä»¥åœ¨<a href="https://github.com/appcoda/SwiftUnitTestDemo" target="_blank" rel="external">è¿™é‡Œä¸‹è½½</a></p>
<p><strong>åŸæ–‡é“¾æ¥</strong>: <a href="http://www.appcoda.com/unit-testing-swift/" target="_blank" rel="external">http://www.appcoda.com/unit-testing-swift/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/09/21/åœ¨Xcode7ä¸­ä½¿ç”¨Swiftè¿›è¡Œå•å…ƒæµ‹è¯•/" data-id="ciytk1esp000dpsuxcgbo30eo" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-HealthKit-ä½¿ç”¨ç¬”è®°-ä¸€" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/05/HealthKit-ä½¿ç”¨ç¬”è®°-ä¸€/" class="article-date">
  <time datetime="2016-08-05T09:18:21.000Z" itemprop="datePublished">2016-08-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/05/HealthKit-ä½¿ç”¨ç¬”è®°-ä¸€/">HealthKit ä½¿ç”¨ç¬”è®°(ä¸€)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ä¸ºä»€ä¹ˆè¦ç”¨HealthKit"><a href="#ä¸ºä»€ä¹ˆè¦ç”¨HealthKit" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ç”¨HealthKit"></a>ä¸ºä»€ä¹ˆè¦ç”¨HealthKit</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  å…¬å¸åœ¨åšä¸€æ¬¾å¥åº·ç±»çš„app, è¦å°†å„ç±»ç¬¬ä¸‰æ–¹è®¾å¤‡æ•°æ®ç»Ÿè®¡èµ·æ¥,è€Œè¿åŠ¨ä½œä¸ºå”¯ä¸€ä¸€ä¸ªæ‰‹æœºæœ¬èº«å°±å¯ä»¥æµ‹é‡è®¡æ­¥çš„åŠŸèƒ½æ¨¡å—,è¦å¥½å¥½åˆ©ç”¨èµ·æ¥.ç”±äºäº§å“äººå‘˜æœ¬èº«æ²¡æœ‰å¯¹æ‰‹æœºè®¡æ­¥åŠŸèƒ½çš„æ•°æ®ç»Ÿè®¡åšå‡ºå…·ä½“çš„é€»è¾‘è¦æ±‚, ä»¥è‡³äºè‡ªå·±å¼€å‘è¿‡ç¨‹ä¸­åˆ†åˆ«ç»å†äº†å‡ ä¸ªé˜¶æ®µ</span><br><span class="line">1. èµ·åˆä¸ºäº†å®ç°å®æ—¶è®¡æ­¥åŠŸèƒ½,è‡ªå·±é€‰ç”¨äº†CoreMotionæ¡†æ¶,å› ä¸ºCoreMotionæ¡†æ¶çš„å®æ—¶æ€§æ›´å¥½,ä¸”è¯»å–æ•°æ®æ›´ç®€å•</span><br><span class="line">2. ä¸€æ®µæ—¶é—´å,é¢†å¯¼ä»¬è§‰å¾—æ—¢ç„¶ç”¨æˆ·ç»™äº†è¯»å–æ•°æ®çš„æƒé™,é‚£ä¹ˆéœ€è¦å°†ç”¨æˆ·çš„å†å²æ•°æ®ä¿å­˜èµ·æ¥,ä»¥å¤‡æ—¥åæ•°æ®åˆ†æ ??, æ‰€ä»¥è‡ªå·±æ¥å…¥äº†HealthKitæ¡†æ¶ç”¨æ¥ä¿å­˜å†å²æ•°æ®,åŒæ—¶ä½¿ç”¨CoreMotionå®æ—¶è®¡æ­¥.</span><br><span class="line">3. å†åæ¥, æœåŠ¡å™¨åŒå­¦è§‰å¾— å®æ—¶è®¡æ­¥ç„¶åå®æ—¶å‘æœåŠ¡å™¨ä¸Šä¼ çš„æ–¹å¼ä¸å¥½, å¹¶ä¸”è¿˜å‡ºç°äº†ä¸€äº›å…¶ä»–å°é—®é¢˜,æ‰€ä»¥æˆ‘åˆå°†CoreMotionæ¡†æ¶åˆ é™¤,å¹¶ä½¿ç”¨HealthKitç»Ÿè®¡å½“æ—¥è¿åŠ¨æ­¥æ•°æ•°æ®??. å½“æ—¶çš„å¾®ä¿¡è¿åŠ¨çš„æ•°æ®åº”è¯¥ä¹Ÿåªå–äº†æ•°æ®æºä¸ºæœ¬æœºçš„æ•°æ®, å› æ­¤é¢†å¯¼è¦æ±‚æˆ‘ä»¬çš„appéœ€è¦ä¿è¯å’Œå¾®ä¿¡ä¸€æ ·åªå–æ•°æ®æºä¸º&quot;æ‰‹æœº&quot;çš„æ•°æ®??</span><br><span class="line">4. åˆåæ¥, appéœ€è¦å…¼å®¹iOS10, ä¸æ­¤åŒæ—¶,é¢†å¯¼å‘ç°&quot;å’¦, æ€ä¹ˆå¾®ä¿¡æ•°æ®å’Œæˆ‘ä»¬æ•°æ®ä¸ä¸€è‡´?!blablababalala&quot;. äºæ˜¯åªå¥½,åˆç ”ç©¶HealthKit??, å®å®ä¸å¼€å¿ƒ</span><br></pre></td></tr></table></figure>
<h2 id="çŸ¥è¯†ç‚¹è®°å½•"><a href="#çŸ¥è¯†ç‚¹è®°å½•" class="headerlink" title="çŸ¥è¯†ç‚¹è®°å½•"></a>çŸ¥è¯†ç‚¹è®°å½•</h2><h3 id="CoreMotion"><a href="#CoreMotion" class="headerlink" title="CoreMotion"></a>CoreMotion</h3><ul>
<li>åˆ¤æ–­å½“å‰æ‰‹æœºæ˜¯å¦æ”¯æŒè®¡æ­¥(æ˜¯å¦åŒ…å«M7ä»¥ä¸Šåå¤„ç†å™¨, iPhone5sä»¥ä¸Šæœºå‹æ”¯æŒ)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//å®æ—¶ä»ç³»ç»Ÿä¸­è¯»å–æ•°æ® M7å¤„ç†å™¨åŠŸèƒ½æ˜¯ä¸æ˜¯å¯ç”¨</span><br><span class="line">if (![CMPedometer isStepCountingAvailable])</span><br><span class="line"> &#123;</span><br><span class="line">    return ;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¯»å–æ•°æ®</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CMPedometer *pedometer = [[CMPedometer alloc] init];</span><br><span class="line">NSDate *startDate = ...;</span><br><span class="line">NSDate *toDate = [NSDate date];</span><br><span class="line"> [pedometer queryPedometerDataFromDate:startDate</span><br><span class="line">                                       toDate:endDate</span><br><span class="line">                                  withHandler:</span><br><span class="line">    ^(CMPedometerData *pedometerData, NSError *error) </span><br><span class="line">&#123;</span><br><span class="line">  //do whatever you want</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å®æ—¶æ›´æ–°æ•°æ®</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CMPedometer *pedometer = [[CMPedometer alloc] init];</span><br><span class="line"> [pedometer startPedometerUpdatesFromDate:fromDate withHandler:^(CMPedometerData *  _Nullable pedometerData, NSError * _Nullable error) </span><br><span class="line"> &#123;</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="HealthKit"><a href="#HealthKit" class="headerlink" title="HealthKit"></a>HealthKit</h3><ul>
<li>ä»¥ä¸‹çš„æ‰€æœ‰ <code>self.healthStore</code> é€šè¿‡ <code>getter</code> æ–¹æ³•è·å¾—</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (HKHealthStore *)healthStore</span><br><span class="line">&#123;</span><br><span class="line">    if (!_healthStore) &#123;</span><br><span class="line">        _healthStore = [[HKHealthStore alloc]init];</span><br><span class="line">    &#125;</span><br><span class="line">    return _healthStore;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>åˆ¤æ–­å½“å‰æ‰‹æœºæ˜¯å¦æ”¯æŒHealthKitæ¡†æ¶</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)isHealthDataAvailable</span><br><span class="line">&#123;</span><br><span class="line">    return [HKHealthStore isHealthDataAvailable];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è·å¾—ä½¿ç”¨ç”¨æˆ·æ•°æ®çš„æƒé™</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**è·å¾—ä½¿ç”¨æˆæƒ */</span><br><span class="line">- (void)authorizateHealthKit:(void(^)(BOOL isAuthorizateSucess))resultBlock</span><br><span class="line">&#123;</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW,</span><br><span class="line">                                 (int64_t)(1.0 * NSEC_PER_SEC)),</span><br><span class="line">                   dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                       NSSet *readObjectTypes =</span><br><span class="line">                       //æ­¥æ•°</span><br><span class="line">                       [NSSet setWithObjects:</span><br><span class="line">                        [HKObjectType quantityTypeForIdentifier:HKQuantityTypeIdentifierStepCount],</span><br><span class="line">                        //è¡€ç³–</span><br><span class="line">                        [HKObjectType quantityTypeForIdentifier:HKQuantityTypeIdentifierBloodGlucose],</span><br><span class="line">                        //å¿ƒè„æ”¶ç¼©å‹</span><br><span class="line">                        [HKObjectType quantityTypeForIdentifier:HKQuantityTypeIdentifierBloodPressureSystolic],</span><br><span class="line">                        //å¿ƒè„èˆ’å¼ å‹</span><br><span class="line">                        [HKObjectType quantityTypeForIdentifier:HKQuantityTypeIdentifierBloodPressureDiastolic],</span><br><span class="line">                                                 nil];</span><br><span class="line">                       </span><br><span class="line">                       [self.healthStore</span><br><span class="line">                        requestAuthorizationToShareTypes:nil</span><br><span class="line">                        readTypes:readObjectTypes</span><br><span class="line">                        completion:^(BOOL success, NSError * _Nullable error)</span><br><span class="line">                        &#123;</span><br><span class="line">                            if (resultBlock) &#123;</span><br><span class="line">                                resultBlock(success);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è·å¾—æ—¥ç»Ÿè®¡æ•°æ®</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">/** è·å¾—å½“æ—¥å±•ç¤ºæ•°æ®*/</span><br><span class="line">- (void)fetchHealthMotionDailyData:(void(^)(NSDictionary *resultDictionary))resultBlock</span><br><span class="line">&#123;</span><br><span class="line">    /**ä»HealthKitä¸­è¯»å–æ•°æ®*/</span><br><span class="line">    [self authorizateHealthKit:^(BOOL isAuthorizateSucess) &#123;</span><br><span class="line">        </span><br><span class="line">        if (!isAuthorizateSucess) &#123;</span><br><span class="line">            //æˆæƒå¤±è´¥,æç¤ºç”¨æˆ·</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        __block NSMutableDictionary *tempDictionary = [NSMutableDictionary dictionaryWithCapacity:1];</span><br><span class="line">        [self fetchSampleDataResultBlock:^(NSDictionary *queryResultDict) &#123;</span><br><span class="line">            int stepValue;</span><br><span class="line">            if ([queryResultDict.allKeys containsObject:@&quot;sampleStepCount&quot;]) &#123;</span><br><span class="line">            //æ­¤å¤„å³ä¸ºæ‰€å¾—åˆ°çš„è¿åŠ¨æ­¥æ•°</span><br><span class="line">                stepValue = ((NSNumber *)queryResultDict[@&quot;sampleStepCount&quot;]).intValue;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                stepValue = 0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;];</span><br><span class="line">        </span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)fetchSampleDataResultBlock:(void(^)(NSDictionary *queryResultDict))resultBlock</span><br><span class="line">&#123;</span><br><span class="line">    NSMutableDictionary *tempDict = @&#123;&#125;.mutableCopy;</span><br><span class="line"></span><br><span class="line">    NSDateFormatter *formatter = [[NSDateFormatter alloc]init];</span><br><span class="line">    [formatter setDateFormat:@&quot;yyyy-MM-dd&quot;];</span><br><span class="line">    NSString *today = [formatter stringFromDate:[NSDate date]];</span><br><span class="line">    NSDate *fromDate = [MMUtils stringToDate:today isStart:YES];</span><br><span class="line">    </span><br><span class="line">    HKSampleType *sampleType = [HKSampleType quantityTypeForIdentifier:HKQuantityTypeIdentifierStepCount];</span><br><span class="line">    __block double totalStepCount = 0;//æ€»æ­¥è¡Œæ•°</span><br><span class="line"></span><br><span class="line">    //TODO:----0805</span><br><span class="line">    //è·å–å½“æ—¥æ•°æ®æœ‰ä¿©ç§æ–¹æ³•</span><br><span class="line">    if (0) &#123;</span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line">#pragma clang diagnostic ignored &quot;-Wunreachable-code&quot;</span><br><span class="line">        //1.ç¬¬ä¸€ç§æ–¹æ³•ä¸º æŒ‰æ—¶é—´ç‚¹æ•°æ®ç´¯åŠ ,ä½†å½“æ•°æ®æºæœ‰è‹¥å¹²ä¸ªæ—¶,ç´¯åŠ çš„æ•°æ®ä¼šå˜æˆæ‰€æœ‰æ•°æ®æºæ•°æ®ä¹‹å’Œ</span><br><span class="line">        [self executeQueryQuantityType:sampleType startDate:fromDate endDate:[NSDate date] callBackResultBlock:^(NSArray * _Nullable results, NSError *error) &#123;</span><br><span class="line">            </span><br><span class="line">            for (HKQuantitySample *sample in results)</span><br><span class="line">            &#123;</span><br><span class="line">                //æ ¹æ®æ•°æ®æºç´¯åŠ æ•°æ®</span><br><span class="line">                if ([sample.source.name isEqualToString:[UIDevice currentDevice].name])</span><br><span class="line">                &#123;</span><br><span class="line">                    double stepCount = [sample.quantity doubleValueForUnit:[HKUnit countUnit]];</span><br><span class="line">                    </span><br><span class="line">                    totalStepCount += stepCount;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            [tempDict setObject:@(totalStepCount) forKey:kTotalSampleStepCountKey];</span><br><span class="line">            </span><br><span class="line">            if (resultBlock) &#123;</span><br><span class="line">                resultBlock(tempDict);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line"> #pragma clang diagnostic pop</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //2.ç¬¬äºŒç§æ–¹æ³•ä¸ºè·å–å½“æ—¥æ•°æ®çš„ç»Ÿè®¡æ•°æ®,ä½¿ç”¨è¿™ç§æ–¹å¼,å¯ä»¥åœ¨æœ‰è‹¥å¹²æ•°æ®æºæ—¶,è·å¾—ä¸&quot;å¥åº·app&quot;ç›¸å¯¹åº”çš„ç»Ÿè®¡æ•°æ®</span><br><span class="line">    HKQuantityType *quantityType = [HKQuantityType quantityTypeForIdentifier:HKQuantityTypeIdentifierStepCount];</span><br><span class="line"></span><br><span class="line">    [self executeQueryQuantityType:quantityType startDate:fromDate endDate:[NSDate date] callBackResultBlock:^(NSArray * _Nullable results, NSError *error) &#123;</span><br><span class="line">        </span><br><span class="line">        HKStatistics *result = results[0];</span><br><span class="line">        HKQuantity *sum = [result sumQuantity];//æ­¤å¤„å³ä¸ºè¯·æ±‚å½“æ—¥å·²ç»ç»Ÿè®¡è¿‡çš„æ•°æ®</span><br><span class="line">        double stepCount = [sum doubleValueForUnit:[HKUnit countUnit]];</span><br><span class="line">        [tempDict setObject:@(stepCount) forKey:kTotalSampleStepCountKey];</span><br><span class="line">        if (resultBlock) &#123;</span><br><span class="line">            resultBlock(tempDict);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æŸ¥è¯¢æ•°æ®</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">//æ•°æ®ç‚¹æŸ¥è¯¢</span><br><span class="line"></span><br><span class="line">- (void)executeQueryQuantityType:(HKSampleType *)quantityType</span><br><span class="line">                       startDate:(NSDate *)startDate</span><br><span class="line">                         endDate:(NSDate *)endDate</span><br><span class="line">             callBackResultBlock:(void(^)(NSArray * __nullable results, NSError *error))resultBlock</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    HKQuantityType *stepType = [HKObjectType quantityTypeForIdentifier:HKQuantityTypeIdentifierStepCount];</span><br><span class="line">    NSPredicate *predicate = [HKQuery predicateForSamplesWithStartDate:startDate endDate:endDate options:HKQueryOptionStrictStartDate];</span><br><span class="line">    NSSortDescriptor *sortDescriptor = [NSSortDescriptor sortDescriptorWithKey:HKSampleSortIdentifierStartDate ascending:YES];</span><br><span class="line">    </span><br><span class="line">    //TODO:----0805 è¦æ±‚æŸ¥è¯¢ç»Ÿè®¡æ•°æ®</span><br><span class="line"></span><br><span class="line">    if (0) &#123;</span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line">#pragma clang diagnostic ignored &quot;-Wunreachable-code&quot;</span><br><span class="line">//æŒ‰ç…§æŸ¥è¯¢æ¡ä»¶,è¿”å›æ»¡è¶³æ—¶é—´æ®µå†…çš„æ‰€æœ‰æ•°æ®</span><br><span class="line">        HKSampleQuery *sampleQuery = [[HKSampleQuery alloc] initWithSampleType:stepType</span><br><span class="line">                                                                     predicate:predicate</span><br><span class="line">                                                                         limit:HKObjectQueryNoLimit</span><br><span class="line">                                                               sortDescriptors:@[sortDescriptor]</span><br><span class="line">                                                                resultsHandler:^(HKSampleQuery *query, NSArray *results, NSError *error)</span><br><span class="line">                                      &#123;</span><br><span class="line">                                          if (resultBlock) &#123;</span><br><span class="line">                                              resultBlock(results, error);</span><br><span class="line">                                          &#125;</span><br><span class="line">                                          </span><br><span class="line">                                      &#125;];</span><br><span class="line">        [self.healthStore executeQuery:sampleQuery];</span><br><span class="line">#pragma clang diagnostic pop</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //æŸ¥è¯¢å½“å¤©æ•°æ®çš„ç»Ÿè®¡æ•°æ®</span><br><span class="line">    //æŸ¥è¯¢æ•°æ®çš„æ—¶é—´é—´éš”</span><br><span class="line">    NSDateComponents *intervalCompents = [[NSDateComponents alloc]init];</span><br><span class="line">    intervalCompents.day = 1;</span><br><span class="line">    </span><br><span class="line">    //æŸ¥è¯¢æ•°æ®çš„å¼€å§‹æ—¶é—´(é”šç‚¹ anchordate)</span><br><span class="line">    //1.è·å–æ—¥å†</span><br><span class="line">    NSCalendar *calendar = [NSCalendar calendarWithIdentifier:NSCalendarIdentifierGregorian];</span><br><span class="line">    </span><br><span class="line">    //2.å½“å‰æ—¶é—´ç»„ä»¶</span><br><span class="line">    NSDateComponents *currentCompents = [calendar components:NSCalendarUnitSecond|NSCalendarUnitMinute|NSCalendarUnitHour fromDate:[NSDate date]];</span><br><span class="line">    NSDate *sendDate = [NSDate dateWithTimeIntervalSinceNow:0];</span><br><span class="line">    </span><br><span class="line">    //æŸ¥è¯¢æ¡ä»¶ (10å¤© * 24å°æ—¶ )</span><br><span class="line">    NSDate *sstartDate = [NSDate dateWithTimeIntervalSinceNow:-(currentCompents.hour * 3600 + currentCompents.minute * 60 + currentCompents.second)];</span><br><span class="line">    NSPredicate *spredicate = [HKQuery predicateForSamplesWithStartDate:sstartDate endDate:sendDate options:HKQueryOptionStrictStartDate];</span><br><span class="line">    </span><br><span class="line">    [self executeStatisticsQueryForQuantityType:stepType predicate:spredicate anchorDate:sendDate intervalComponents:intervalCompents callBackResult:^(HKStatistics * _Nullable result, NSError *error) &#123;</span><br><span class="line">        if (resultBlock) &#123;</span><br><span class="line">            resultBlock(@[result], error);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//ç»Ÿè®¡æ•°æ®</span><br><span class="line">- (void)executeStatisticsQueryForQuantityType:(HKQuantityType *)quantityType</span><br><span class="line">                          predicate:(nullable NSPredicate *)quantitySamplePredicate</span><br><span class="line">                         anchorDate:(NSDate *)anchorDate</span><br><span class="line">                 intervalComponents:(NSDateComponents *)intervalComponents</span><br><span class="line">                     callBackResult:(void (^)(HKStatistics * __nullable result, NSError *error))queryResult</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    HKStatisticsQuery *statisticQuery =</span><br><span class="line">    [[HKStatisticsQuery alloc]initWithQuantityType:quantityType quantitySamplePredicate:quantitySamplePredicate options:HKStatisticsOptionCumulativeSum completionHandler:^(HKStatisticsQuery * _Nonnull query, HKStatistics * _Nullable result, NSError * _Nullable error) &#123;</span><br><span class="line">        if (queryResult) &#123;</span><br><span class="line">            queryResult(result, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [self.healthStore executeQuery:statisticQuery];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æŸ¥è¯¢æŒ‡å®šæ—¥æœŸæ—¶é—´æ®µå†…çš„æ•°æ®,æ­¤å¤„ä¸ºå‰10æ—¥</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">//æŸ¥è¯¢æŒ‡å®šæ—¥æœŸæ—¶é—´æ®µçš„æ•°æ®(å‰10æ—¥)</span><br><span class="line">- (void)fetchAllHealthDataByDay:(void(^)(NSArray *dataArray))resultBlock</span><br><span class="line">&#123;</span><br><span class="line">    HKQuantityType *quantityType = [HKQuantityType quantityTypeForIdentifier:HKQuantityTypeIdentifierStepCount];</span><br><span class="line">    </span><br><span class="line">    //æŸ¥è¯¢æ•°æ®çš„æ—¶é—´é—´éš”</span><br><span class="line">    NSDateComponents *intervalCompents = [[NSDateComponents alloc]init];</span><br><span class="line">    intervalCompents.day = 1;</span><br><span class="line">    </span><br><span class="line">    //æŸ¥è¯¢æ•°æ®çš„å¼€å§‹æ—¶é—´(é”šç‚¹ anchordate)</span><br><span class="line">    //1.è·å–æ—¥å†</span><br><span class="line">    NSCalendar *calendar = [NSCalendar calendarWithIdentifier:NSCalendarIdentifierGregorian];</span><br><span class="line">    </span><br><span class="line">    //2.å½“å‰æ—¶é—´ç»„ä»¶</span><br><span class="line">    NSDateComponents *currentCompents = [calendar components:NSCalendarUnitSecond|NSCalendarUnitMinute|NSCalendarUnitHour fromDate:[NSDate date]];</span><br><span class="line">    NSDate *endDate = [NSDate dateWithTimeIntervalSinceNow:-(currentCompents.hour * 3600 + currentCompents.minute * 60 + currentCompents.second)];</span><br><span class="line">    </span><br><span class="line">    //æŸ¥è¯¢æ¡ä»¶ (10å¤© * 24å°æ—¶ )</span><br><span class="line">    NSDate *startDate = [NSDate dateWithTimeIntervalSinceNow:-(currentCompents.hour * 3600 + currentCompents.minute * 60 + currentCompents.second + 10 * 24 * 3600)];</span><br><span class="line">    NSPredicate *predicate = [HKQuery predicateForSamplesWithStartDate:startDate endDate:endDate options:HKQueryOptionStrictStartDate];</span><br><span class="line">    //TODO:0805---å¾…ä¿®æ”¹</span><br><span class="line">        [self executeQueryForQuantityType:quantityType</span><br><span class="line">                                predicate:predicate</span><br><span class="line">                               anchorDate:endDate</span><br><span class="line">                       intervalComponents:intervalCompents</span><br><span class="line">                           callBackResult:^(HKStatisticsCollection * _Nullable result, NSError *error) &#123;</span><br><span class="line">                               </span><br><span class="line">                               __block NSMutableArray *tempArray = @[].mutableCopy;</span><br><span class="line">                               [result.statistics enumerateObjectsUsingBlock:^(HKStatistics * _Nonnull statistics,</span><br><span class="line">                                                                               NSUInteger idx, BOOL * _Nonnull statisticsStop) &#123;</span><br><span class="line">                                  /* [statistics.sources enumerateObjectsUsingBlock:^(HKSource * _Nonnull source,</span><br><span class="line">                                                                                    NSUInteger idx, BOOL * _Nonnull sourceStop) &#123;</span><br><span class="line">                                       </span><br><span class="line">                                      // double stepCount = [[statistics sumQuantityForSource:source] doubleValueForUnit:[HKUnit countUnit]];</span><br><span class="line">                                       </span><br><span class="line">                                        double stepCount = [[statistics sumQuantity] doubleValueForUnit:[HKUnit countUnit]];</span><br><span class="line">                                       NSDateFormatter *formatter = [[NSDateFormatter alloc]init];</span><br><span class="line">                                       [formatter setDateFormat:@&quot;yyyy-MM-dd&quot;];</span><br><span class="line">                                       </span><br><span class="line">                                       NSString *stringDate = [formatter stringFromDate:statistics.startDate];</span><br><span class="line">                                       //NSLog(@&quot;******** %f, %@&quot;,stepCount, stringDate);</span><br><span class="line">                                       </span><br><span class="line">                                       </span><br><span class="line">                                       NSDictionary *tempDictionary = [NSDictionary dictionaryWithObjectsAndKeys:stringDate, @&quot;date_time&quot;,@(stepCount),@&quot;step&quot;, nil];</span><br><span class="line">                                       </span><br><span class="line">                                       [tempArray insertObject:tempDictionary atIndex:0];</span><br><span class="line">                                       *sourceStop = YES;</span><br><span class="line">                                   &#125;];*/</span><br><span class="line">                                   </span><br><span class="line">                                   </span><br><span class="line">                                   double stepCount = [[statistics sumQuantity] doubleValueForUnit:[HKUnit countUnit]];</span><br><span class="line">                                   int step = (int)ceil(stepCount);</span><br><span class="line">                                   NSDateFormatter *formatter = [[NSDateFormatter alloc]init];</span><br><span class="line">                                   [formatter setDateFormat:@&quot;yyyy-MM-dd&quot;];</span><br><span class="line">                                   </span><br><span class="line">                                   NSString *stringDate = [formatter stringFromDate:statistics.startDate];</span><br><span class="line">                                   //NSLog(@&quot;******** %f, %@&quot;,stepCount, stringDate);</span><br><span class="line">                                   </span><br><span class="line">                                   </span><br><span class="line">                                   NSDictionary *tempDictionary = [NSDictionary dictionaryWithObjectsAndKeys:stringDate, @&quot;date_time&quot;,@(step),@&quot;step&quot;, nil];</span><br><span class="line">                                   </span><br><span class="line">                                   [tempArray insertObject:tempDictionary atIndex:0];</span><br><span class="line">                               &#125;];</span><br><span class="line">                               </span><br><span class="line">                               if (resultBlock) &#123;</span><br><span class="line">                                   resultBlock(tempArray);</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;];</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">//åˆ†ç±»ç»Ÿè®¡æŸ¥è¯¢</span><br><span class="line">- (void)executeQueryForQuantityType:(HKQuantityType *)quantityType</span><br><span class="line">                          predicate:(nullable NSPredicate *)quantitySamplePredicate</span><br><span class="line">                         anchorDate:(NSDate *)anchorDate</span><br><span class="line">                 intervalComponents:(NSDateComponents *)intervalComponents</span><br><span class="line">                     callBackResult:(void (^)(HKStatisticsCollection * __nullable result, NSError *error))queryResult</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    HKStatisticsCollectionQuery *collectionQuery =</span><br><span class="line">    [[HKStatisticsCollectionQuery alloc] initWithQuantityType:quantityType</span><br><span class="line">                                      quantitySamplePredicate:quantitySamplePredicate</span><br><span class="line">                                                      options:HKStatisticsOptionCumulativeSum | HKStatisticsOptionSeparateBySource</span><br><span class="line">                                                   anchorDate:anchorDate</span><br><span class="line">                                           intervalComponents:intervalComponents];</span><br><span class="line">    </span><br><span class="line">    collectionQuery.initialResultsHandler = ^(HKStatisticsCollectionQuery *query, HKStatisticsCollection * __nullable result, NSError * __nullable error)&#123;</span><br><span class="line">        if (queryResult) &#123;</span><br><span class="line">            queryResult(result, error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    [self.healthStore executeQuery:collectionQuery];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol>
<li>è¿™æ¬¡ä½¿ç”¨HealthKitè¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°äº†ä¸‰ç§query, åˆ†åˆ«ä¸º<code>HKStatisticsCollectionQuery</code> , <code>HKStatisticsQuery</code>, <code>HKSampleQuery</code>, ä¸åŒçš„queryè¿”å›çš„æ•°æ®ç»“æœä¸åŒ, æ ¹æ®ä¸åŒçš„åœºæ™¯,ä½¿ç”¨ä¸åŒçš„æŸ¥è¯¢æ–¹å¼. </li>
<li>HealthKité‡Œé¢è¿˜æœ‰å¾ˆå¤šä¸œè¥¿éœ€è¦å­¦ä¹ , è¿™æ¬¡å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ç†è§£çš„ä¹Ÿä¸é€å½»,éœ€è¦ä»¥åä¸æ–­åŠ å¼º</li>
</ol>
<p><em>å‚è€ƒé“¾æ¥</em></p>
<ol>
<li>iOS 8 HealthKit ä»‹ç» <a href="http://vit0.com/blog/2014/10/30/ios-8-healthkit-jie-shao/" target="_blank" rel="external">http://vit0.com/blog/2014/10/30/ios-8-healthkit-jie-shao/</a> </li>
<li>HealthKitDemo <a href="https://github.com/MarsCWD/HealthKitDemo" target="_blank" rel="external">https://github.com/MarsCWD/HealthKitDemo</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/08/05/HealthKit-ä½¿ç”¨ç¬”è®°-ä¸€/" data-id="ciytk1eru0002psuxsboiupy1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ç»˜åˆ¶å°¾éƒ¨å¸¦æœ‰åœ†åœˆçš„åœ†ç¯" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/02/ç»˜åˆ¶å°¾éƒ¨å¸¦æœ‰åœ†åœˆçš„åœ†ç¯/" class="article-date">
  <time datetime="2016-08-02T10:49:58.000Z" itemprop="datePublished">2016-08-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/02/ç»˜åˆ¶å°¾éƒ¨å¸¦æœ‰åœ†åœˆçš„åœ†ç¯/">ç»˜åˆ¶å°¾éƒ¨å¸¦æœ‰åœ†åœˆçš„åœ†ç¯</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#ç»˜åˆ¶å°¾éƒ¨å¸¦æœ‰åœ†åœˆçš„åœ†ç¯</p>
<h2 id="UIè®¾è®¡ç¨¿å¦‚ä¸‹"><a href="#UIè®¾è®¡ç¨¿å¦‚ä¸‹" class="headerlink" title="UIè®¾è®¡ç¨¿å¦‚ä¸‹"></a>UIè®¾è®¡ç¨¿å¦‚ä¸‹</h2><p><img src="/img/1.png" alt="å±å¹•å¿«ç…§ 2016-08-02 17.37.42-w640"></p>
<h2 id="çŸ¥è¯†å…³é”®ç‚¹"><a href="#çŸ¥è¯†å…³é”®ç‚¹" class="headerlink" title="çŸ¥è¯†å…³é”®ç‚¹"></a>çŸ¥è¯†å…³é”®ç‚¹</h2><ul>
<li>ç”¨<code>CAShapeLayer</code>ç»˜åˆ¶åœ†ç¯</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (CAShapeLayer *)shaperLayerRadius:(CGFloat)radius</span><br><span class="line">                    fillColor:(UIColor *)fillColor</span><br><span class="line">                  strokeColor:(UIColor *)strokeColor</span><br><span class="line">                           endAngle:(CGFloat)endAngle</span><br><span class="line">&#123;</span><br><span class="line">    CGFloat centerX = self.backGroundView.frame.size.width / 2.0;</span><br><span class="line">    CGFloat centerY = self.backGroundView.frame.size.height / 2.0;</span><br><span class="line">    </span><br><span class="line">    UIBezierPath *path =</span><br><span class="line">    [UIBezierPath bezierPathWithArcCenter:CGPointMake(centerX, centerY)</span><br><span class="line">                                radius:radius</span><br><span class="line">                            startAngle:M_PI * (-90) / 180.0</span><br><span class="line">                              endAngle:M_PI * (endAngle) / 180.0</span><br><span class="line">                             clockwise:YES];</span><br><span class="line">    CAShapeLayer *layer = [CAShapeLayer layer];</span><br><span class="line">    layer.path = path.CGPath;</span><br><span class="line">    layer.fillColor = fillColor.CGColor;</span><br><span class="line">    layer.strokeColor = strokeColor.CGColor;</span><br><span class="line">    layer.lineWidth = 10.0;</span><br><span class="line">    layer.frame = self.backGroundView.bounds;</span><br><span class="line">    return layer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>CABasicAnimation</code>å®Œæˆåœ†ç¯ç»˜åˆ¶åŠ¨ç”»,ä»¥ä¸‹ä»£ç ä¸­,éœ€è¦ç»˜åˆ¶çš„layerä¸º<code>self.bodyFatLayer</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CABasicAnimation *pathAnimation = [CABasicAnimation animationWithKeyPath:NSStringFromSelector(@selector(strokeEnd))];</span><br><span class="line">pathAnimation.duration = 5.0;</span><br><span class="line">pathAnimation.fromValue = @0;</span><br><span class="line">pathAnimation.toValue = @1;</span><br><span class="line">[self.bodyFatLayer addAnimation:pathAnimation forKey:NSStringFromSelector(@selector(strokeEnd))];</span><br></pre></td></tr></table></figure>
<ul>
<li>è®¡ç®—å°¾éƒ¨åœ†ç¯çš„ä½ç½®å…¬å¼ä¸º</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">åœ†ç‚¹åæ ‡ï¼š(x0,y0)</span><br><span class="line">    </span><br><span class="line">åŠå¾„ï¼šr</span><br><span class="line">è§’åº¦ï¼ša0</span><br><span class="line">    </span><br><span class="line">åˆ™åœ†ä¸Šä»»ä¸€ç‚¹ä¸ºï¼šï¼ˆx1,y1ï¼‰</span><br><span class="line">x1   =   x0   +   r   *   cos(ao   *   3.14   /180   )</span><br><span class="line">y1   =   y0   +   r   *   sin(ao   *   3.14   /180   )</span><br></pre></td></tr></table></figure>
<ul>
<li>åŠ¨ç”»å¼€å§‹ä¹‹å‰è®¡ç®—<code>self.bodyFatValueLayer</code>åœ¨viewä¸­çš„ä½ç½®,å¹¶æ·»åŠ åŠ¨ç”»</li>
<li><code>CAKeyframeAnimation</code> å®Œæˆå°¾éƒ¨åœ†ç¯çš„åŠ¨ç”»,å…¶ä¸­åŠ¨ç”»æ‰€éœ€è¦çš„<code>path</code>ç”±åœ†ç¯<code>self.bodyFatLayer</code>çš„<code>path</code>å†³å®š.ä»¥ä¸‹ä»£ç ä¸­éœ€è¦æ²¿ç€åœ†ç¯è½¨è¿¹è¿åŠ¨çš„<code>layer</code>ä¸º<code>self.bodyFatValueLayer</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CAKeyframeAnimation *penAnimation = [CAKeyframeAnimation animationWithKeyPath:@&quot;position&quot;];</span><br><span class="line">penAnimation.duration = 5.0;</span><br><span class="line">penAnimation.path = self.bodyFatLayer.path;</span><br><span class="line">penAnimation.calculationMode = kCAAnimationPaced;</span><br><span class="line">[self.bodyFatValueLayer addAnimation:penAnimation forKey:@&quot;penAnimation&quot;];</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/08/02/ç»˜åˆ¶å°¾éƒ¨å¸¦æœ‰åœ†åœˆçš„åœ†ç¯/" data-id="ciytk1eu0000zpsuxtdqp6muf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/04/è½¯è½¯è™¾æˆé•¿è®°/">è½¯è½¯è™¾æˆé•¿è®°</a>
          </li>
        
          <li>
            <a href="/2017/02/02/è€æˆ¿å­/">è€æˆ¿å­</a>
          </li>
        
          <li>
            <a href="/2017/01/31/å€™æœºæœ‰æ„Ÿ/">å€™æœºæœ‰æ„Ÿ</a>
          </li>
        
          <li>
            <a href="/2017/01/30/å’¬æ­»äººçš„è€è™/">å’¬æ­»äººçš„è€è™</a>
          </li>
        
          <li>
            <a href="/2017/01/28/å¤§å¹´åˆä¸€/">å¤§å¹´åˆä¸€</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Summer<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>